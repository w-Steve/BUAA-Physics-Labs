<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 自准直法测量凹透镜焦距</title>
    <!-- 公共样式 (完全复用1-1的style.css) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (完全复用common.js) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (与1-1完全相同) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">自准直法测量凹透镜焦距</div>

    <!-- 实验要点提示 (严格按6-3.docx归纳) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 测量凹透镜五次：记录 $x_{A左}$、$x_{A右}$、$x_{L2正}$、$x_{L2反}$ (单位 cm)<br>
        • 计算 $x_A = (x_{A左}+x_{A右})/2$，$x_{L2} = (x_{L2正}+x_{L2反})/2$<br>
        • 焦距公式：$f = -|x_{L2} - x_A|$<br>
        • B类不确定度：仪器误差 $\Delta = 0.05\,\mathrm{cm}$，则 $u_B = \Delta/\sqrt{3}$ (直接用于 $x_A$ 和 $x_{L2}$)<br>
        • 合成不确定度：$u(f) = \sqrt{u^2(x_A) + u^2(x_{L2})}$，其中 $u(x_A)=\sqrt{u_A^2(x_A)+u_B^2}$，$u(x_{L2})$ 同理
    </div>

    <!-- 原始数据录入区 (仿1-1结构，增加仪器误差可调) -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 仪器误差Δ (可调，默认0.05 cm) -->
        <div class="top-input-group" style="margin-bottom: 1rem;">
            <div class="top-input">
                <label>$\Delta$仪 (cm):</label>
                <input type="number" id="deltaInst" class="save-input cell-input" step="0.01" value="0.05">
            </div>
        </div>

        <!-- 原始数据表格容器 (5行4列: xA左, xA右, xL2正, xL2反) -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">测量数据 (5次)</div>
            <div id="raw-table-container" class="data-table"></div>
        </div>
    </div>

    <!-- 操作按钮组 (与1-1完全一致) -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (仿1-1) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">焦距 $f$ (cm)</div><div class="result-value" id="f_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(f)$ (cm)</div><div class="result-value" id="uf_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(f)/|f|$</div><div class="result-value" id="rel_uf_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 (包含中间表格，仿1-1) -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 (与1-1相同) -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '6-3';   // 本地存储唯一标识

    // ---------- 获取所有输入值 (原始数据 + Δ仪) ----------
    function getInputs() {
        const deltaInst = parseFloat(document.getElementById('deltaInst').value) || 0.05;

        // 读取原始表格: 容器 #raw-table-container 下所有 .cell-input (共20个，顺序：行1左,行1右,行1正,行1反, 行2...)
        const container = document.getElementById('raw-table-container');
        const inputs = container.querySelectorAll('input.cell-input');
        if (inputs.length !== 20) throw new Error('表格输入框数量异常');

        const rawValues = Array.from(inputs).map(inp => parseFloat(inp.value));
        // 检查是否有NaN
        if (rawValues.some(v => isNaN(v))) {
            throw new Error('存在未填写的单元格');
        }

        // 按行组织：每行4个 [左, 右, 正, 反]
        const rows = [];
        for (let i = 0; i < 5; i++) {
            const base = i * 4;
            rows.push({
                left: rawValues[base],
                right: rawValues[base + 1],
                zheng: rawValues[base + 2],
                fan: rawValues[base + 3]
            });
        }
        return { deltaInst, rows };
    }

    // ---------- 数据有效性检查 (简单检查, 无需额外) ----------
    function isValid(data) {
        return data.rows.length === 5; // 已经通过parse检查
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { deltaInst, rows } = data;
        const uB = deltaInst / Math.sqrt(3);   // B类不确定度 (用于xA和xL2)

        // 计算每行的 xA, xL2, |xL2 - xA|
        const xAArr = [];
        const xL2Arr = [];
        const diffArr = [];      // 绝对值差值
        rows.forEach(row => {
            const xA = (row.left + row.right) / 2;
            const xL2 = (row.zheng + row.fan) / 2;
            xAArr.push(xA);
            xL2Arr.push(xL2);
            diffArr.push(Math.abs(xL2 - xA));
        });

        // 平均值
        const avgXA = xAArr.reduce((a,b) => a+b, 0) / 5;
        const avgXL2 = xL2Arr.reduce((a,b) => a+b, 0) / 5;
        const avgDiff = diffArr.reduce((a,b) => a+b, 0) / 5;
        const f = -avgDiff;   // 焦距 (负值)

        // A类不确定度 (平均值的标准误差)
        const uA_xA = window.ExperimentUtils.Data.stdErrorOfMean(xAArr);
        const uA_xL2 = window.ExperimentUtils.Data.stdErrorOfMean(xL2Arr);

        // 合成不确定度 for xA and xL2
        const u_xA = Math.hypot(uA_xA, uB);
        const u_xL2 = Math.hypot(uA_xL2, uB);

        // 焦距的合成不确定度 u(f) = sqrt( u^2(xA) + u^2(xL2) )
        const u_f = Math.hypot(u_xA, u_xL2);
        const relU = Math.abs(u_f / f);   // 相对不确定度

        return {
            rows,                // 原始行数据
            xAArr, xL2Arr, diffArr,
            avgXA, avgXL2, avgDiff,
            f,
            uA_xA, uA_xL2,
            uB,
            u_xA, u_xL2,
            u_f, relU,
            deltaInst
        };
    }

    // ---------- 渲染详细计算过程 (包含中间表格, 仿1-1风格) ----------
    function renderProcess(res) {
        const utils = window.ExperimentUtils;
        const [fDisplay, ufDisplay] = utils.formatResultWithUncertainty(res.f, res.u_f);

        // 辅助：生成残差平方字符串 (用于A类不确定度展示)
        const formatResiduals = (arr, mean) => arr.map(v => {
            const diff = v - mean;
            return (diff < 0 ? `(${diff.toFixed(4)})` : diff.toFixed(4)) + '²';
        }).join(' + ');

        // 构建中间数据表格 (HTML)
        const interTableRows = [];
        for (let i = 0; i < 5; i++) {
            interTableRows.push(`
                <tr>
                    <td>${i+1}</td>
                    <td>${res.xAArr[i].toFixed(4)}</td>
                    <td>${res.xL2Arr[i].toFixed(4)}</td>
                    <td>${res.diffArr[i].toFixed(4)}</td>
                </tr>
            `);
        }
        const interTableHtml = `
            <div class="output-table-wrapper">
                <table class="output-table">
                    <thead><tr><th>次数</th><th>$x_A$ (cm)</th><th>$x_{L2}$ (cm)</th><th>$|x_{L2}-x_A|$ (cm)</th></tr></thead>
                    <tbody>${interTableRows.join('')}</tbody>
                </table>
            </div>
        `;

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 中间数据计算</div>
            <div class="step-formula">原始数据 (已读取):</div>
            <div class="step-formula">${interTableHtml}</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 平均值计算</div>
            <div class="step-formula">$$\\bar{x}_A = \\frac{${res.xAArr.map(v => v.toFixed(4)).join('+')}}{5} = ${res.avgXA.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\bar{x}_{L2} = \\frac{${res.xL2Arr.map(v => v.toFixed(4)).join('+')}}{5} = ${res.avgXL2.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\overline{|x_{L2}-x_A|} = \\frac{${res.diffArr.map(v => v.toFixed(4)).join('+')}}{5} = ${res.avgDiff.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">焦距平均值 $f = -\\overline{|x_{L2}-x_A|} = ${res.f.toFixed(4)}\\ \\mathrm{cm}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. A类不确定度 (平均值的标准误差)</div>
            <div class="step-formula">$u_A(x_A) = \\sqrt{\\frac{${formatResiduals(res.xAArr, res.avgXA)}}{5×4}} = ${res.uA_xA.toFixed(6)}$ cm</div>
            <div class="step-formula">$u_A(x_{L2}) = \\sqrt{\\frac{${formatResiduals(res.xL2Arr, res.avgXL2)}}{5×4}} = ${res.uA_xL2.toFixed(6)}$ cm</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. B类不确定度</div>
            <div class="step-formula">仪器误差 $\Delta = ${res.deltaInst.toFixed(3)}$ cm，则 $u_B = \\frac{\\Delta}{\\sqrt{3}} = \\frac{${res.deltaInst.toFixed(3)}}{1.732} = ${res.uB.toFixed(6)}$ cm</div>
            <div class="step-formula">(直接用于 $x_A$ 和 $x_{L2}$ 的B类分量)</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 合成不确定度：$x_A$ 和 $x_{L2}$</div>
            <div class="step-formula">$u(x_A) = \\sqrt{u_A^2(x_A) + u_B^2} = \\sqrt{${res.uA_xA.toFixed(6)}^2 + ${res.uB.toFixed(6)}^2} = ${res.u_xA.toFixed(6)}$ cm</div>
            <div class="step-formula">$u(x_{L2}) = \\sqrt{u_A^2(x_{L2}) + u_B^2} = \\sqrt{${res.uA_xL2.toFixed(6)}^2 + ${res.uB.toFixed(6)}^2} = ${res.u_xL2.toFixed(6)}$ cm</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">6. 焦距不确定度 $u(f)$</div>
            <div class="step-formula">$$u(f) = \\sqrt{u^2(x_A) + u^2(x_{L2})} = \\sqrt{${res.u_xA.toFixed(6)}^2 + ${res.u_xL2.toFixed(6)}^2} = ${res.u_f.toFixed(6)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">相对不确定度 $\\frac{u(f)}{|f|} = \\frac{${res.u_f.toFixed(6)}}{${Math.abs(res.f).toFixed(6)}} = ${res.relU.toFixed(6)}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">7. 最终结果</div>
            <div class="step-result" style="font-size:1.2rem;">$f = (${fDisplay} \\pm ${ufDisplay})\\ \\mathrm{cm}$</div>
            <div class="step-result">相对不确定度 = ${(res.relU*100).toFixed(2)} %</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果 (卡片) ----------
    function displayResults(res) {
        const [fRounded, ufRounded] = window.ExperimentUtils.formatResultWithUncertainty(res.f, res.u_f);
        document.getElementById('f_val').innerText = fRounded;
        document.getElementById('uf_val').innerText = ufRounded;
        document.getElementById('rel_uf_val').innerText = res.relU.toFixed(6);
        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        try {
            const data = getInputs();
            if (!isValid(data)) {
                alert('数据不完整，请确保所有单元格均已填写');
                return;
            }
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);   // 同时保存当前输入
        } catch (e) {
            console.error(e);
            alert('计算过程出错：' + e.message);
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 (表格生成, 加载数据, 键盘导航, 深色模式) ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成原始数据表格：5行4列，带行头
        // 默认示例数值 (使焦距约 -20 cm)
        const defaultVals = [
            // 行1: 左,右,正,反
            52.30, 58.10, 32.50, 38.20,
            // 行2
            52.40, 58.20, 32.60, 38.30,
            // 行3
            52.35, 58.15, 32.55, 38.25,
            // 行4
            52.45, 58.25, 32.65, 38.35,
            // 行5
            52.38, 58.18, 32.58, 38.28
        ];

        TableGenerator.generateInputTable('raw-table-container', {
            rows: 5,
            cols: 4,
            colHeaders: ['次数', '$x_{A左}$ (cm)', '$x_{A右}$ (cm)', '$x_{L2正}$ (cm)', '$x_{L2反}$ (cm)'],
            rowHeaders: ['1', '2', '3', '4', '5'],
            prefix: 'raw_',
            defaultValues: defaultVals
        });

        // 如果本地无保存数据，则额外设置deltaInst默认值 (但已有value="0.05")
        if (!localStorage.getItem(APP_KEY)) {
            // 可以留空，因为HTML中已有默认值
        }

        // 加载保存的数据 (会覆盖表格及deltaInst)
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航 (列数为4)
        window.ExperimentUtils.KeyboardNav.init('#raw-table-container', 4);

        // 深色模式初始化 (自动添加切换按钮)
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>