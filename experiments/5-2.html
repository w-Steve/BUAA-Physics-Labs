<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 最小偏向角法测量棱镜折射率</title>
    <!-- 公共样式 (与1-1相同) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (存储、表格生成、键盘导航、深色模式) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (与1-1一致) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
    <style>
        /* 针对角度输入框微调：使用等宽字体方便读数 */
        .cell-input[type="text"] {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            text-align: center;
        }
        .angle-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
            text-align: center;
        }
        .dark-mode .angle-hint {
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-title">最小偏向角法测量棱镜折射率</div>

    <!-- 实验要点提示 (已修改为度分说明) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 棱镜角 $A$ (°) —— 直接输入十进制度，如 $60.0$° 表示 $60°00'$<br>
        • 角度测量数据采用 <strong>度.分</strong> 格式输入：例如 $120.15$ 表示 $120°15'$，$45.4$ 表示 $45°04'$，$300.40$ 表示 $300°40'$<br>
        • 三次测量：$\alpha_1,\beta_1$ (望远镜位置Ⅰ) ;  $\alpha_2,\beta_2$ (望远镜位置Ⅱ)<br>
        • 本实验不要求不确定度
    </div>

    <!-- 原始数据录入区 -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 棱镜角 A (十进制度) -->
        <div class="top-input-group" style="margin-bottom: 1.5rem;">
            <div class="top-input">
                <label>$A$ (°):</label>
                <input type="number" id="angleA" class="save-input cell-input" step="any" value="60.00" placeholder="60.0">
            </div>
            <span style="color: #64748b; font-size:0.9rem;">直接输入十进制度，例如 60.5 表示 60.5°</span>
        </div>

        <!-- 测量数据表格 (α1,β1,α2,β2 三次) 容器 -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">角度测量数据 (3次，单位: 度.分)</div>
            <div id="measure-table-container" class="data-table"></div>
            <div class="angle-hint">例如: 120.15 = 120°15′ &nbsp; 300.4 = 300°04′ &nbsp; 60.40 = 60°40′</div>
        </div>
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (折射率 n) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">折射率 $n$</div><div class="result-value" id="n_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '5-2';

    // ---------- 度分 ⇄ 十进制度 专用函数 (与5-1完全相同) ----------
    function degreeMinuteToDecimal(degMinStr) {
        if (!degMinStr || degMinStr.trim() === '') return NaN;
        const str = degMinStr.trim();
        const value = parseFloat(str);
        if (isNaN(value)) return NaN;
        const degrees = Math.floor(Math.abs(value)) * Math.sign(value);
        const decimalIndex = str.indexOf('.');
        if (decimalIndex === -1) return degrees;
        
        const decimalStr = str.substring(decimalIndex + 1);
        let minutes;
        if (decimalStr.length === 1) {
            minutes = parseInt(decimalStr, 10);
        } else {
            minutes = parseInt(decimalStr.substring(0, 2), 10);
        }
        return degrees + minutes / 60;
    }

    function decimalToDegreeMinute(decimal) {
        if (isNaN(decimal)) return '—';
        const absDeg = Math.abs(decimal);
        const deg = Math.floor(absDeg);
        const min = Math.round((absDeg - deg) * 60);
        return (decimal < 0 ? '-' : '') + deg + '°' + min + '′';
    }

    // ---------- 构建角度输入表格 (3行,4列, 类似5-1的buildAngleTable) ----------
    function buildAngleTable(containerId, prefix, rowCount, colCount, colHeaders, defaultValues) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        const tableDiv = document.createElement('div');
        tableDiv.className = 'data-table';

        if (colHeaders && colHeaders.length) {
            const headerRow = document.createElement('div');
            headerRow.className = 'table-header';
            colHeaders.forEach(text => {
                const cell = document.createElement('div');
                cell.className = 'header-cell';
                cell.textContent = text;
                headerRow.appendChild(cell);
            });
            tableDiv.appendChild(headerRow);
        }

        for (let r = 0; r < rowCount; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'table-row';

            const idxCell = document.createElement('div');
            idxCell.className = 'header-cell';
            idxCell.textContent = (r + 1).toString();
            rowDiv.appendChild(idxCell);

            for (let c = 0; c < colCount; c++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.inputMode = 'decimal';
                input.className = 'cell-input save-input';
                const idx = r * colCount + c + 1;
                input.id = `${prefix}${idx}`;
                if (defaultValues && defaultValues[idx-1] !== undefined) {
                    input.value = defaultValues[idx-1];
                } else {
                    input.value = '';
                }
                input.placeholder = '度.分';
                rowDiv.appendChild(input);
            }
            tableDiv.appendChild(rowDiv);
        }

        container.appendChild(tableDiv);
    }

    // ---------- 获取所有输入值 (角度A为数字, 表格数据为字符串, 需转换) ----------
    function getInputs() {
        const angleA = parseFloat(document.getElementById('angleA').value) || 0;

        // 读取测量表格数据: 共3行×4列, id按行主序: pm_1 ~ pm_12
        const alpha1 = [], beta1 = [], alpha2 = [], beta2 = [];
        for (let i = 0; i < 3; i++) {
            const base = i * 4;
            const a1Str = document.getElementById(`pm_${base+1}`)?.value || '';
            const b1Str = document.getElementById(`pm_${base+2}`)?.value || '';
            const a2Str = document.getElementById(`pm_${base+3}`)?.value || '';
            const b2Str = document.getElementById(`pm_${base+4}`)?.value || '';
            alpha1.push(a1Str);
            beta1.push(b1Str);
            alpha2.push(a2Str);
            beta2.push(b2Str);
        }

        return {
            angleA,
            alpha1Str: alpha1, beta1Str: beta1, alpha2Str: alpha2, beta2Str: beta2
        };
    }

    // ---------- 有效性检查 (所有度分字符串必须可转换) ----------
    function isValid(data) {
        if (isNaN(data.angleA) || data.angleA <= 0) return false;
        const { alpha1Str, beta1Str, alpha2Str, beta2Str } = data;
        for (let i = 0; i < 3; i++) {
            const a1 = degreeMinuteToDecimal(alpha1Str[i]);
            const b1 = degreeMinuteToDecimal(beta1Str[i]);
            const a2 = degreeMinuteToDecimal(alpha2Str[i]);
            const b2 = degreeMinuteToDecimal(beta2Str[i]);
            if (isNaN(a1) || isNaN(b1) || isNaN(a2) || isNaN(b2)) return false;
        }
        return true;
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { angleA, alpha1Str, beta1Str, alpha2Str, beta2Str } = data;

        // 转换为数值
        const alpha1 = alpha1Str.map(s => degreeMinuteToDecimal(s));
        const beta1  = beta1Str.map(s => degreeMinuteToDecimal(s));
        const alpha2 = alpha2Str.map(s => degreeMinuteToDecimal(s));
        const beta2  = beta2Str.map(s => degreeMinuteToDecimal(s));

        // 计算每次的 θ1, θ2, δ_min
        const theta1List = [];
        const theta2List = [];
        const deltaList = [];
        for (let i = 0; i < 3; i++) {
            const t1 = alpha1[i] - alpha2[i];
            const t2 = beta1[i] - beta2[i];
            const d = (t1 + t2) / 2;
            theta1List.push(t1);
            theta2List.push(t2);
            deltaList.push(d);
        }

        // 平均最小偏向角
        const avgDelta = deltaList.reduce((a, b) => a + b, 0) / 3;

        // 计算折射率 n = sin((avgDelta + A)/2) / sin(A/2)   (角度转弧度)
        const A_rad = angleA * Math.PI / 180;
        const avgDelta_rad = avgDelta * Math.PI / 180;
        const numerator = Math.sin((avgDelta_rad + A_rad) / 2);
        const denominator = Math.sin(A_rad / 2);
        const n = numerator / denominator;

        return {
            angleA,
            alpha1Str, beta1Str, alpha2Str, beta2Str,  // 原始字符串
            alpha1, beta1, alpha2, beta2,              // 转换后的数值
            theta1List,
            theta2List,
            deltaList,
            avgDelta,
            n
        };
    }

    // ---------- 渲染详细计算过程 ----------
    function renderProcess(res) {
        const f = (x) => x.toFixed(6);
        const f4 = (x) => x.toFixed(4);
        const angleA = res.angleA;

        // 生成原始数据对照表
        const rowsRaw = [];
        for (let i = 0; i < 3; i++) {
            rowsRaw.push(`
                <tr>
                    <td>${i+1}</td>
                    <td>${res.alpha1Str[i]}</td><td>${f4(res.alpha1[i])}°</td>
                    <td>${res.beta1Str[i]}</td><td>${f4(res.beta1[i])}°</td>
                    <td>${res.alpha2Str[i]}</td><td>${f4(res.alpha2[i])}°</td>
                    <td>${res.beta2Str[i]}</td><td>${f4(res.beta2[i])}°</td>
                </tr>
            `);
        }

        // 生成中间量表格
        const rowsMid = [];
        for (let i = 0; i < 3; i++) {
            rowsMid.push(`
                <tr>
                    <td>${i+1}</td>
                    <td>${f4(res.theta1List[i])}°</td>
                    <td>${f4(res.theta2List[i])}°</td>
                    <td>${f4(res.deltaList[i])}°</td>
                </tr>
            `);
        }

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 原始读数（度.分）与转换后的十进制度</div>
            <div class="output-table-wrapper">
                <table class="output-table">
                    <thead>
                        <tr><th>次数</th><th>α₁<br>(度.分)</th><th>α₁ (°)</th><th>β₁<br>(度.分)</th><th>β₁ (°)</th><th>α₂<br>(度.分)</th><th>α₂ (°)</th><th>β₂<br>(度.分)</th><th>β₂ (°)</th></tr>
                    </thead>
                    <tbody>${rowsRaw.join('')}</tbody>
                </table>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 计算每组的中间角度</div>
            <div class="step-formula">$\\theta_1 = \\alpha_1 - \\alpha_2$，$\\theta_2 = \\beta_1 - \\beta_2$，$\\delta_{\\min} = (\\theta_1+\\theta_2)/2$</div>
            <div class="output-table-wrapper" style="margin-top:1rem;">
                <table class="output-table">
                    <thead><tr><th>次数</th><th>θ₁ (°)</th><th>θ₂ (°)</th><th>δ_min (°)</th></tr></thead>
                    <tbody>${rowsMid.join('')}</tbody>
                </table>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 平均最小偏向角 $\\bar{\\delta}_{\\min}$</div>
            <div class="step-formula">$$\\bar{\\delta}_{\\min} = \\frac{${res.deltaList.map(d => f(d)).join(' + ')}}{3} = ${f(res.avgDelta)}^\\circ$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 折射率 n 计算</div>
            <div class="step-formula">$$A = ${f(angleA)}^\\circ, \\quad \\bar{\\delta}_{\\min} = ${f(res.avgDelta)}^\\circ$$</div>
            <div class="step-formula">$$\\frac{\\bar{\\delta}_{\\min} + A}{2} = \\frac{${f(res.avgDelta)} + ${f(angleA)}}{2} = ${f((res.avgDelta+angleA)/2)}^\\circ$$</div>
            <div class="step-formula">$$\\sin\\frac{\\bar{\\delta}_{\\min} + A}{2} = \\sin(${f((res.avgDelta+angleA)/2)}^\\circ) = ${Math.sin((res.avgDelta+angleA)/2*Math.PI/180).toFixed(8)}$$</div>
            <div class="step-formula">$$\\sin\\frac{A}{2} = \\sin(${f(angleA/2)}^\\circ) = ${Math.sin(angleA/2*Math.PI/180).toFixed(8)}$$</div>
            <div class="step-formula">$$n = \\frac{\\sin\\frac{\\bar{\\delta}_{\\min}+A}{2}}{\\sin\\frac{A}{2}} = \\frac{${Math.sin((res.avgDelta+angleA)/2*Math.PI/180).toFixed(8)}}{${Math.sin(angleA/2*Math.PI/180).toFixed(8)}} = ${res.n.toFixed(8)}$$</div>
            <div class="step-result">折射率 $n = ${res.n.toFixed(8)}$</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果 ----------
    function displayResults(res) {
        document.getElementById('n_val').innerText = res.n.toFixed(8);
        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或格式错误：请确保棱镜角 A > 0 且三次测量的 α₁,β₁,α₂,β₂ 均已填写正确的度分格式。');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 ----------
    window.addEventListener('DOMContentLoaded', function() {
        // 构建测量表格 (3行,4列) 使用度分格式
        buildAngleTable('measure-table-container', 'pm_', 3, 4,
            ['次数', 'α₁ (度.分)', 'β₁ (度.分)', 'α₂ (度.分)', 'β₂ (度.分)'],
            [   // 默认示例数据 (度.分)
                '120.15', '300.15', '60.30', '240.30',   // 第一次
                '120.20', '300.20', '60.35', '240.35',   // 第二次
                '120.10', '300.10', '60.25', '240.25'    // 第三次
            ]
        );

        // 若本地无保存，设置默认棱镜角 A
        if (!localStorage.getItem(APP_KEY)) {
            document.getElementById('angleA').value = '60.00';
        }

        // 加载保存数据（会覆盖默认值）
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航 (表格共4列)
        window.ExperimentUtils.KeyboardNav.init('#measure-table-container', 4);

        // 深色模式
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>

<!-- 确保输出表格样式与1-1一致 -->
<style>
    .output-table { width: 100%; border-collapse: collapse; background: transparent; }
    .output-table th { background: #f8fafc; font-weight: 500; padding: 0.5rem; }
    .dark-mode .output-table th { background: #374151; }
    .output-table td { padding: 0.5rem; text-align: center; border-bottom: 1px solid #e2e8f0; }
</style>
</body>
</html>