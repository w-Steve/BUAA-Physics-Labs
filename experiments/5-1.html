<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手- -三棱镜顶角测量</title>
    <!-- 公共样式 (与1-1共用) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (存储、键盘导航、深色模式、表格生成) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (与1-1完全相同) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
    <style>
        /* 针对角度输入框微调：使用等宽字体方便读数 */
        .cell-input[type="text"] {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            text-align: center;
        }
        /* 角度输入提示 */
        .angle-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
            text-align: center;
        }
        .dark-mode .angle-hint {
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-title">三棱镜顶角测量</div>

    <!-- 实验要点提示 -->
    <div class="tip-box">
        <strong>实验要点</strong><br>
        • 角度输入格式：<strong>度.分</strong>  (例如 12.25 表示 12°25′, 12.4 表示 12°04′, 12.40 表示 12°40′)<br>
        • AB面：α₁ , β₁ &nbsp;&nbsp; AC面：α₂ , β₂  (各测量5次)<br>
        <img src="../images/1.jpg" style="max-width: 100%; height: auto;" alt="不确定度">
    </div>

    <!-- 原始数据录入区 (两个表格) -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- AB面表格容器 (5行2列) -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">AB面测量 (α₁ , β₁)  <span style="font-weight:normal; margin-left:1rem; color:#2563eb;">格式: 度.分</span></div>
            <div id="ab-table-container" class="data-table"></div>
            <div class="angle-hint">例如: 120.15 = 120°15′ &nbsp; 45.4 = 45°04′ &nbsp; 300.40 = 300°40′</div>
        </div>

        <!-- AC面表格容器 (5行2列) -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">AC面测量 (α₂ , β₂)  <span style="font-weight:normal; margin-left:1rem; color:#2563eb;">格式: 度.分</span></div>
            <div id="ac-table-container" class="data-table"></div>
            <div class="angle-hint">例如: 60.30 = 60°30′ &nbsp; 240.5 = 240°05′ &nbsp; 120.10 = 120°10′</div>
        </div>

        <!-- 没有额外的输入框，所有数据来自表格 -->
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (A, u(A), 相对不确定度) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">顶角 $A$ (度)</div><div class="result-value" id="a_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(A)$ (度)</div><div class="result-value" id="ua_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(A)/A$</div><div class="result-value" id="rel_ua_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 (与1-1相同) -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '5-1';

    // ---------- 度分 ⇄ 十进制度 专用函数 (保留原始字符串解析) ----------
    function degreeMinuteToDecimal(degMinStr) {
        if (!degMinStr || degMinStr.trim() === '') return NaN;
        const str = degMinStr.trim();
        const value = parseFloat(str);
        if (isNaN(value)) return NaN;
        const degrees = Math.floor(Math.abs(value)) * Math.sign(value);
        const decimalIndex = str.indexOf('.');
        if (decimalIndex === -1) return degrees;
        
        const decimalStr = str.substring(decimalIndex + 1);
        let minutes;
        if (decimalStr.length === 1) {
            minutes = parseInt(decimalStr, 10);
        } else {
            minutes = parseInt(decimalStr.substring(0, 2), 10);
        }
        return degrees + minutes / 60;
    }

    function decimalToDegreeMinute(decimal) {
        if (isNaN(decimal)) return '—';
        const absDeg = Math.abs(decimal);
        const deg = Math.floor(absDeg);
        const min = Math.round((absDeg - deg) * 60);
        return (decimal < 0 ? '-' : '') + deg + '°' + min + '′';
    }

    function decimalToDegreeMinuteFixed(decimal, fixed=2) {
        if (isNaN(decimal)) return '—';
        const absDeg = Math.abs(decimal);
        const deg = Math.floor(absDeg);
        const min = ((absDeg - deg) * 60).toFixed(fixed);
        return (decimal < 0 ? '-' : '') + deg + '°' + min + '′';
    }

    // ---------- 获取所有输入值 ----------
    function getInputs() {
        const abAlpha1 = [], abBeta1 = [];
        for (let i = 0; i < 5; i++) {
            const alpha1 = document.getElementById(`ab_${i*2+1}`)?.value || '';
            const beta1  = document.getElementById(`ab_${i*2+2}`)?.value || '';
            abAlpha1.push(alpha1);
            abBeta1.push(beta1);
        }

        const acAlpha2 = [], acBeta2 = [];
        for (let i = 0; i < 5; i++) {
            const alpha2 = document.getElementById(`ac_${i*2+1}`)?.value || '';
            const beta2  = document.getElementById(`ac_${i*2+2}`)?.value || '';
            acAlpha2.push(alpha2);
            acBeta2.push(beta2);
        }

        return { abAlpha1, abBeta1, acAlpha2, acBeta2 };
    }

    // ---------- 数据有效性检查 ----------
    function isValid(data) {
        const { abAlpha1, abBeta1, acAlpha2, acBeta2 } = data;
        for (let i = 0; i < 5; i++) {
            if (!abAlpha1[i].trim() || !abBeta1[i].trim() || !acAlpha2[i].trim() || !acBeta2[i].trim()) {
                return false;
            }
            if (isNaN(degreeMinuteToDecimal(abAlpha1[i])) ||
                isNaN(degreeMinuteToDecimal(abBeta1[i]))  ||
                isNaN(degreeMinuteToDecimal(acAlpha2[i])) ||
                isNaN(degreeMinuteToDecimal(acBeta2[i]))) {
                return false;
            }
        }
        return true;
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { abAlpha1, abBeta1, acAlpha2, acBeta2 } = data;

        const theta1Arr = [], theta2Arr = [], deltaArr = [], Aarr = [];
        for (let i = 0; i < 5; i++) {
            const a1 = degreeMinuteToDecimal(abAlpha1[i]);
            const b1 = degreeMinuteToDecimal(abBeta1[i]);
            const a2 = degreeMinuteToDecimal(acAlpha2[i]);
            const b2 = degreeMinuteToDecimal(acBeta2[i]);

            const theta1 = a1 - a2;
            const theta2 = b1 - b2;
            let delta = theta1 + theta2;
            if (delta < 0) delta += 360;
            const A = delta / 2;

            theta1Arr.push(theta1);
            theta2Arr.push(theta2);
            deltaArr.push(delta);
            Aarr.push(A);
        }

        const Data = window.ExperimentUtils.Data;
        const avgTheta1 = Data.mean(theta1Arr);
        const avgTheta2 = Data.mean(theta2Arr);
        const avgDelta  = Data.mean(deltaArr);
        const avgA      = Data.mean(Aarr);

        let sumSqDelta = 0;
        for (let i = 0; i < 5; i++) {
            sumSqDelta += (deltaArr[i] - avgDelta) ** 2;
        }
        const stdDevDelta = (5 > 1) ? Math.sqrt(sumSqDelta / 4) : 0;
        const uDeltaA = stdDevDelta / Math.sqrt(5);

        const uDeltaB = (1/60) / Math.sqrt(3);
        const uDelta = Math.hypot(uDeltaA, uDeltaB);
        const uA = uDelta / 2;
        const relU = uA / avgA;

        return {
            abAlpha1, abBeta1, acAlpha2, acBeta2,
            theta1Arr, theta2Arr, deltaArr, Aarr,
            avgTheta1, avgTheta2, avgDelta, avgA,
            uDeltaA, uDeltaB, uDelta, uA, relU,
            stdDevDelta,
            count: 5
        };
    }

    // ---------- 渲染详细计算过程 (移除原始读数步骤，中间表格使用统一样式) ----------
    function renderProcess(res) {
        const [aDisplay, uaDisplay] = window.ExperimentUtils.formatResultWithUncertainty(res.avgA, res.uA);

        // 辅助生成残差平方和字符串
        function formatSqResiduals(arr, mean) {
            return arr.map(v => {
                const diff = v - mean;
                return (diff < 0 ? `(${diff.toFixed(4)})` : diff.toFixed(4)) + '²';
            }).join(' + ');
        }

        // 构建中间量表格 (使用统一样式 .output-table)
        const tableRows = [];
        for (let i = 0; i < 5; i++) {
            tableRows.push(`
                <tr>
                    <td>${i+1}</td>
                    <td>${res.theta1Arr[i].toFixed(4)}</td>
                    <td>${res.theta2Arr[i].toFixed(4)}</td>
                    <td>${res.deltaArr[i].toFixed(4)}</td>
                    <td>${res.Aarr[i].toFixed(4)}</td>
                </tr>
            `);
        }

        const html = `
        <!-- 步骤1: 中间量表格 -->
        <div class="calculation-step">
            <div class="step-title">1. 转换为十进制度并计算中间量</div>
            <div class="step-formula">
                <div class="output-table-wrapper">
                    <table class="output-table">
                        <thead>
                            <tr>
                                <th>次数</th>
                                <th>θ₁ = α₁-α₂</th>
                                <th>θ₂ = β₁-β₂</th>
                                <th>δ = θ₁+θ₂</th>
                                <th>A = δ/2</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows.join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="step-formula">(若δ<0则加360°，本例均已调整)</div>
        </div>

        <!-- 步骤2: 平均值计算 (详细求和式子，小数形式) -->
        <div class="calculation-step">
            <div class="step-title">2. 平均值计算</div>
            <div class="step-formula">$$\\bar{\\theta}_1 = \\frac{${res.theta1Arr.map(v => v.toFixed(4)).join(' + ')}}{5} = ${res.avgTheta1.toFixed(4)}°$$</div>
            <div class="step-formula">$$\\bar{\\theta}_2 = \\frac{${res.theta2Arr.map(v => v.toFixed(4)).join(' + ')}}{5} = ${res.avgTheta2.toFixed(4)}°$$</div>
            <div class="step-formula">$$\\bar{\\delta} = \\frac{${res.deltaArr.map(v => v.toFixed(4)).join(' + ')}}{5} = ${res.avgDelta.toFixed(4)}°$$</div>
            <div class="step-formula">$$\\bar{A} = \\frac{${res.Aarr.map(v => v.toFixed(4)).join(' + ')}}{5} = ${res.avgA.toFixed(4)}°$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. δ的A类不确定度 $u_A(\\delta)$</div>
            <div class="step-formula">标准差 $$s(\\delta)=\\sqrt{\\frac{${formatSqResiduals(res.deltaArr, res.avgDelta)}}{5-1}} = ${res.stdDevDelta.toFixed(6)}°$$</div>
            <div class="step-formula">$$u_A(\\delta)=\\frac{s(\\delta)}{\\sqrt{5}} = \\frac{${res.stdDevDelta.toFixed(6)}}{\\sqrt{5}} = ${res.uDeltaA.toFixed(6)}°$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. B类不确定度 (仪器误差)</div>
            <div class="step-formula">$$u_B(\\delta)=\\frac{1'}{\\sqrt{3}} = \\frac{1/60}{\\sqrt{3}} = ${res.uDeltaB.toFixed(6)}°$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 合成不确定度 $u(\\delta)$ 及 $u(A)$</div>
            <div class="step-formula">$$u(\\delta)=\\sqrt{u_A^2+u_B^2} = \\sqrt{(${res.uDeltaA.toFixed(6)})^2 + (${res.uDeltaB.toFixed(6)})^2} = ${res.uDelta.toFixed(6)}°$$</div>
            <div class="step-formula">$$u(A)=\\frac{u(\\delta)}{2} = \\frac{${res.uDelta.toFixed(6)}}{2} = ${res.uA.toFixed(6)}°$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">6. 相对不确定度</div>
            <div class="step-formula">$$\\frac{u(A)}{\\bar{A}} = \\frac{${res.uA.toFixed(6)}}{${res.avgA.toFixed(6)}} = ${res.relU.toFixed(6)}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">7. 最终结果 (修约)</div>
            <div class="step-result" style="font-size:1.2rem;">$$A = (${aDisplay} \\pm ${uaDisplay})\\ \\text{度}$$</div>
            <div class="step-result">相对不确定度 = $\\frac{u(A)}{A} = ${(res.relU*100).toFixed(2)}\\%$</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果卡片 ----------
    function displayResults(res) {
        const [aRounded, uaRounded] = window.ExperimentUtils.formatResultWithUncertainty(res.avgA, res.uA);
        document.getElementById('a_val').innerText = aRounded;
        document.getElementById('ua_val').innerText = uaRounded;
        document.getElementById('rel_ua_val').innerText = res.relU.toFixed(6);
        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或格式错误，请确保所有5次测量的α₁,β₁,α₂,β₂均已填写正确的度分格式');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 初始化表格 ----------
    function buildAngleTable(containerId, prefix, rowCount, colCount, colHeaders, defaultValues) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        const tableDiv = document.createElement('div');
        tableDiv.className = 'data-table';

        if (colHeaders && colHeaders.length) {
            const headerRow = document.createElement('div');
            headerRow.className = 'table-header';
            colHeaders.forEach(text => {
                const cell = document.createElement('div');
                cell.className = 'header-cell';
                cell.textContent = text;
                headerRow.appendChild(cell);
            });
            tableDiv.appendChild(headerRow);
        }

        for (let r = 0; r < rowCount; r++) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'table-row';

            const idxCell = document.createElement('div');
            idxCell.className = 'header-cell';
            idxCell.textContent = (r + 1).toString();
            rowDiv.appendChild(idxCell);

            for (let c = 0; c < colCount; c++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.inputMode = 'decimal';
                input.className = 'cell-input save-input';
                const idx = r * colCount + c + 1;
                input.id = `${prefix}${idx}`;
                if (defaultValues && defaultValues[idx-1] !== undefined) {
                    input.value = defaultValues[idx-1];
                } else {
                    input.value = '';
                }
                input.placeholder = '度.分';
                rowDiv.appendChild(input);
            }
            tableDiv.appendChild(rowDiv);
        }

        container.appendChild(tableDiv);
    }

    // ---------- 页面启动 ----------
    window.addEventListener('DOMContentLoaded', function() {
        buildAngleTable('ab-table-container', 'ab_', 5, 2, 
            ['次数', 'α₁ (度.分)', 'β₁ (度.分)'],
            [ '120.15', '300.15', '120.20', '300.20', '120.10', '300.10', '120.25', '300.25', '120.05', '300.05' ]
        );

        buildAngleTable('ac-table-container', 'ac_', 5, 2,
            ['次数', 'α₂ (度.分)', 'β₂ (度.分)'],
            [ '60.30', '240.30', '60.35', '240.35', '60.25', '240.25', '60.40', '240.40', '60.20', '240.20' ]
        );

        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        window.ExperimentUtils.KeyboardNav.init('#ab-table-container', 2);
        window.ExperimentUtils.KeyboardNav.init('#ac-table-container', 2);

        window.ExperimentUtils.ThemeManager.init();

        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>