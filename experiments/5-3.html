<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 掠入射法测量棱镜折射率</title>
    <!-- 公共样式 -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 -->
    <script src="common.js"></script>
    <!-- MathJax 配置 -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
    <style>
        /* 针对角度输入框微调 */
        .cell-input[type="text"], .cell-input[type="number"] {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            text-align: center;
        }
        .angle-hint {
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 0.25rem;
            text-align: center;
        }
        .dark-mode .angle-hint {
            color: #9ca3af;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-title">掠入射法测量棱镜折射率</div>

    <!-- 实验要点提示 (已修改为A十进制度，表格度分) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • <strong>顶角 A 直接输入十进制度</strong>，例如 <code>60.5</code> 表示 60.5°；<br>
        • 测量数据 α₁, β₁, α₂, β₂ 采用 <strong>度.分</strong> 格式输入：例如 <code>60.30</code> 表示 60°30′，<code>13.4</code> 表示 13°24′。<br>
        • 计算 θ₁ = α₁ − α₂ , θ₂ = β₁ − β₂ , 入射角 i = (θ₁+θ₂)/2 。<br>
        • 取 i 的平均值，代入公式：
        $$n = \sqrt{ \left( \frac{\cos A + \sin i}{\sin A} \right)^2 + 1 }$$<br>
        • 本实验不要求不确定度，结果保留四位小数。
    </div>

    <!-- 原始数据录入区 -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 棱镜顶角 A (十进制度) -->
        <div class="top-input-group" style="margin-bottom: 1.5rem;">
            <div class="top-input">
                <label>$A$ (°):</label>
                <input type="number" id="A" class="save-input cell-input" step="any" value="60.00" placeholder="例如 60.00">
            </div>
            <div style="color: #64748b; font-size:0.9rem; align-self:center;">
                直接输入十进制度，例如 60.5 表示 60.5°
            </div>
        </div>

        <!-- 测量数据表格 (3行4列) 容器 -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">掠入射测量 (3次，单位: 度.分)</div>
            <div id="measure-table-container" class="data-table"></div>
            <div class="angle-hint">例如: 119.57 = 119°57′ &nbsp; 60.23 = 60°23′</div>
        </div>

    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (折射率 n) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">折射率 $n$</div><div class="result-value" id="n_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '5-3';   // 独立存储键

    // ---------- 度分转换工具 (仅用于表格数据) ----------
    function degreeMinuteToDecimal(degMinStr) {
        if (!degMinStr || degMinStr.trim() === '') return NaN;
        const str = degMinStr.trim();
        const parts = str.split('.');
        let degrees = parseFloat(parts[0]);
        if (isNaN(degrees)) return NaN;

        if (parts.length === 1) {
            return degrees;  // 只有度
        } else {
            let minutesPart = parts[1];
            let minutes;
            if (minutesPart.length === 1) {
                // 如 "13.4" 表示 0.4 * 60 = 24分
                minutes = parseFloat('0.' + minutesPart) * 60;
            } else {
                // 取前两位作为分，后面的当作秒的小数 (本实验忽略秒，但保留精度)
                let mainMinutes = parseFloat(minutesPart.substring(0, 2));
                if (isNaN(mainMinutes)) mainMinutes = 0;
                minutes = mainMinutes;
                if (minutesPart.length > 2) {
                    let secPart = minutesPart.substring(2);
                    let seconds = parseFloat('0.' + secPart) * 60;
                    minutes += seconds / 60;
                }
            }
            return degrees + minutes / 60;
        }
    }

    function decimalToDegreeMinute(decimal) {
        if (isNaN(decimal)) return '—';
        const deg = Math.floor(decimal);
        const minFloat = (decimal - deg) * 60;
        const min = Math.round(minFloat * 100) / 100;  // 保留两位小数显示
        return `${deg}°${min.toFixed(2).padStart(5,'0')}′`;
    }

    // ---------- 获取所有输入值 ----------
    function getInputs() {
        // A 为十进制度数字
        const A_val = parseFloat(document.getElementById('A').value);

        // 读取测量表格 (prefix m_, 3行4列，id从 m_1 到 m_12)
        const alpha1 = [], beta1 = [], alpha2 = [], beta2 = [];
        for (let row = 0; row < 3; row++) {
            const base = row * 4;
            const a1 = document.getElementById(`m_${base+1}`)?.value;
            const b1 = document.getElementById(`m_${base+2}`)?.value;
            const a2 = document.getElementById(`m_${base+3}`)?.value;
            const b2 = document.getElementById(`m_${base+4}`)?.value;
            alpha1.push(a1 || '');
            beta1.push(b1 || '');
            alpha2.push(a2 || '');
            beta2.push(b2 || '');
        }

        return { A_val, alpha1, beta1, alpha2, beta2 };
    }

    // ---------- 数据有效性检查 ----------
    function isValid(data) {
        // 检查 A 是否为有效正数
        if (isNaN(data.A_val) || data.A_val <= 0) return false;
        // 检查三组数据是否都填了
        for (let i = 0; i < 3; i++) {
            if (!data.alpha1[i] || !data.beta1[i] || !data.alpha2[i] || !data.beta2[i]) return false;
        }
        return true;
    }

    // ---------- 核心计算 (返回所有中间值及n) ----------
    function compute(data) {
        const A_dec = data.A_val;  // 已是十进制度
        if (isNaN(A_dec)) throw new Error('顶角A格式错误');

        // 转换每组测量值为十进制度
        const rows = [];
        const theta1List = [], theta2List = [], iList = [];

        for (let i = 0; i < 3; i++) {
            const a1 = degreeMinuteToDecimal(data.alpha1[i]);
            const b1 = degreeMinuteToDecimal(data.beta1[i]);
            const a2 = degreeMinuteToDecimal(data.alpha2[i]);
            const b2 = degreeMinuteToDecimal(data.beta2[i]);
            if (isNaN(a1) || isNaN(b1) || isNaN(a2) || isNaN(b2)) {
                throw new Error(`第${i+1}组数据格式不正确`);
            }

            const theta1 = a1 - a2;
            const theta2 = b1 - b2;
            const i_val = (theta1 + theta2) / 2;

            rows.push({
                alpha1: a1, beta1: b1, alpha2: a2, beta2: b2,
                theta1, theta2, i: i_val
            });
            theta1List.push(theta1);
            theta2List.push(theta2);
            iList.push(i_val);
        }

        // 平均值
        const avgTheta1 = theta1List.reduce((s, v) => s + v, 0) / 3;
        const avgTheta2 = theta2List.reduce((s, v) => s + v, 0) / 3;
        const avgI = iList.reduce((s, v) => s + v, 0) / 3;

        // 计算折射率 n (A_dec, avgI 均为十进制度)
        const A_rad = A_dec * Math.PI / 180;
        const i_rad = avgI * Math.PI / 180;
        const numerator = Math.cos(A_rad) + Math.sin(i_rad);
        const denominator = Math.sin(A_rad);
        const n = Math.sqrt(Math.pow(numerator / denominator, 2) + 1);

        return {
            A_dec,
            rows,
            avgTheta1, avgTheta2, avgI,
            n,
            // 保留原始字符串用于展示
            alpha1Raw: data.alpha1,
            beta1Raw: data.beta1,
            alpha2Raw: data.alpha2,
            beta2Raw: data.beta2
        };
    }

    // ---------- 渲染详细计算过程 ----------
    function renderProcess(res) {
        // 辅助: 显示度分格式
        const rowsHtml = res.rows.map((r, idx) => {
            return `<tr>
                <td>${idx+1}</td>
                <td>${decimalToDegreeMinute(r.theta1)}</td>
                <td>${decimalToDegreeMinute(r.theta2)}</td>
                <td>${decimalToDegreeMinute(r.i)}</td>
            </tr>`;
        }).join('');

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 原始数据</div>
            <div class="step-formula">顶角 A = ${res.A_dec.toFixed(4)}° (十进制度)</div>
            <div class="step-formula">测量值 (度.分)：
                <table class="output-table" style="margin-top:0.5rem;">
                    <thead><tr><th>次数</th><th>α₁</th><th>β₁</th><th>α₂</th><th>β₂</th></tr></thead>
                    <tbody>
                        <tr><td>1</td><td>${res.alpha1Raw[0]}</td><td>${res.beta1Raw[0]}</td><td>${res.alpha2Raw[0]}</td><td>${res.beta2Raw[0]}</td></tr>
                        <tr><td>2</td><td>${res.alpha1Raw[1]}</td><td>${res.beta1Raw[1]}</td><td>${res.alpha2Raw[1]}</td><td>${res.beta2Raw[1]}</td></tr>
                        <tr><td>3</td><td>${res.alpha1Raw[2]}</td><td>${res.beta1Raw[2]}</td><td>${res.alpha2Raw[2]}</td><td>${res.beta2Raw[2]}</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 转换为十进制度并计算中间角</div>
            <table class="output-table">
                <thead><tr><th>次数</th><th>θ₁ = α₁−α₂ (°)</th><th>θ₂ = β₁−β₂ (°)</th><th>i = (θ₁+θ₂)/2 (°)</th></tr></thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 平均值</div>
            <div class="step-formula">
                $$\\bar{\\theta_1} = \\frac{${res.rows.map(r => r.theta1.toFixed(4)).join('+')}}{3} = ${res.avgTheta1.toFixed(6)}^\\circ$$
                $$\\bar{\\theta_2} = \\frac{${res.rows.map(r => r.theta2.toFixed(4)).join('+')}}{3} = ${res.avgTheta2.toFixed(6)}^\\circ$$
                $$\\bar{i} = \\frac{${res.rows.map(r => r.i.toFixed(4)).join('+')}}{3} = ${res.avgI.toFixed(6)}^\\circ$$
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 计算折射率 n</div>
            <div class="step-formula">
                顶角 A = ${res.A_dec.toFixed(6)}°， $\\sin A = ${Math.sin(res.A_dec*Math.PI/180).toFixed(6)}$， $\\cos A = ${Math.cos(res.A_dec*Math.PI/180).toFixed(6)}$<br>
                平均入射角 $\\bar{i} = ${res.avgI.toFixed(6)}°$， $\\sin \\bar{i} = ${Math.sin(res.avgI*Math.PI/180).toFixed(6)}$
            </div>
            <div class="step-formula">
                $$n = \\sqrt{ \\left( \\frac{\\cos A + \\sin \\bar{i}}{\\sin A} \\right)^2 + 1 }$$
                $$= \\sqrt{ \\left( \\frac{${Math.cos(res.A_dec*Math.PI/180).toFixed(6)} + ${Math.sin(res.avgI*Math.PI/180).toFixed(6)}}{${Math.sin(res.A_dec*Math.PI/180).toFixed(6)}} \\right)^2 + 1 }$$
            </div>
            <div class="step-formula">
                中间比值 = ${((Math.cos(res.A_dec*Math.PI/180) + Math.sin(res.avgI*Math.PI/180)) / Math.sin(res.A_dec*Math.PI/180)).toFixed(6)}
            </div>
            <div class="step-result">
                $$n = ${res.n.toFixed(6)}$$
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 最终结果</div>
            <div class="step-result" style="font-size:1.2rem;">
                折射率 $n = ${res.n.toFixed(4)}$
            </div>
            
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果卡片 ----------
    function displayResults(res) {
        document.getElementById('n_val').innerText = res.n.toFixed(4);
        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('请完整填写顶角A（有效正数）和所有三组测量数据 (α₁,β₁,α₂,β₂)');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错：' + e.message);
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成测量表格：3行，4列 (α1,β1,α2,β2)
        TableGenerator.generateInputTable('measure-table-container', {
            rows: 3,
            cols: 4,
            colHeaders: ['次数', 'α₁ (度.分)', 'β₁ (度.分)', 'α₂ (度.分)', 'β₂ (度.分)'],
            rowHeaders: ['1', '2', '3'],
            prefix: 'm_',
            defaultValues: [
                '119.57', '060.23', '299.57', '240.23',
                '119.55', '060.25', '299.55', '240.25',
                '119.58', '060.22', '299.58', '240.22'
            ]
        });

        // 设置顶角A默认值 (若localStorage无数据)
        if (!localStorage.getItem(APP_KEY)) {
            document.getElementById('A').value = '60.00';
        }

        // 加载已保存的数据
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航：表格内列数为4
        window.ExperimentUtils.KeyboardNav.init('#measure-table-container', 4);

        // 深色模式
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>