<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 自准直法测量凸面镜焦距</title>
    <!-- 公共样式 (完全沿用1-1) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (包含存储、统计、表格生成、键盘导航、深色模式等) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (与1-1相同) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">自准直法测量凸面镜焦距</div>

    <!-- 实验要点提示 (包含系统误差δ、公式、不确定度说明) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 测量 $x_{\text{像左}}$、$x_{\text{像右}}$、$x_{\text{凸}}$ 各5次 (单位: cm)<br>
        • 计算 $x_{\text{像}} = \dfrac{x_{\text{像左}}+x_{\text{像右}}}{2}$，再取平均 $\bar{x}_{\text{像}}$、$\bar{x}_{\text{凸}}$<br>
        • 焦距公式: $f = -\dfrac{|\bar{x}_{\text{像}} - \bar{x}_{\text{凸}}|}{2}$  (负号表示虚焦点)<br>
        • 不确定度: $u(f) = \sqrt{u^{2}(x_{\text{像}}) + u^{2}(x_{\text{凸}})}$<br>
    </div>

    <!-- 原始数据录入区 (仅包含一个5行3列的表格) -->
    <div class="section">
        <div class="section-title">原始数据录入 (5次测量)</div>
        <!-- 表格容器: 用于生成 x像左, x像右, x凸 的输入 -->
        <div id="mirror-table-container" class="data-table"></div>
    </div>

    <!-- 操作按钮组 (与1-1完全一致) -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (动态显示) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">焦距 $f$ (cm)</div><div class="result-value" id="f_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(f)$ (cm)</div><div class="result-value" id="uf_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(f)/|f|$</div><div class="result-value" id="rel_uf_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 (逐步推导，可誊抄) -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 (与1-1相同) -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '6-4';   // 用于本地存储的键名

    // ---------- 获取所有输入值 (原始数据: x像左, x像右, x凸) ----------
    function getInputs() {
        // 读取 mirror-table 中生成的输入框, id规则: m_1 ~ m_15
        // 共5行，每行3列: 左、右、凸
        const xLeft = [], xRight = [], xConvex = [];
        for (let i = 0; i < 5; i++) {
            // 第i行: 列1 -> m_?  索引: i*3 + 1 (左), i*3+2 (右), i*3+3 (凸)
            const leftVal = parseFloat(document.getElementById(`m_${i*3+1}`)?.value);
            const rightVal = parseFloat(document.getElementById(`m_${i*3+2}`)?.value);
            const convexVal = parseFloat(document.getElementById(`m_${i*3+3}`)?.value);
            xLeft.push(isNaN(leftVal) ? NaN : leftVal);
            xRight.push(isNaN(rightVal) ? NaN : rightVal);
            xConvex.push(isNaN(convexVal) ? NaN : convexVal);
        }
        return { xLeft, xRight, xConvex };
    }

    // ---------- 数据有效性检查 (5组数据全部有效) ----------
    function isValid(data) {
        const { xLeft, xRight, xConvex } = data;
        for (let i = 0; i < 5; i++) {
            if (isNaN(xLeft[i]) || isNaN(xRight[i]) || isNaN(xConvex[i])) return false;
        }
        return true;
    }

    // ---------- 核心计算 (返回所有中间值与最终结果) ----------
    function compute(data) {
        const { xLeft, xRight, xConvex } = data;

        // 1. 计算每次的 x像 = (左+右)/2
        const xImage = [];
        for (let i = 0; i < 5; i++) {
            xImage.push( (xLeft[i] + xRight[i]) / 2 );
        }

        // 使用 common.js 的 Data 工具
        const Data = window.ExperimentUtils.Data;

        // 2. 平均值
        const avgXImage = Data.mean(xImage);
        const avgXConvex = Data.mean(xConvex);

        // 3. A类不确定度 (平均值的标准误差)
        const uAXImage = Data.stdErrorOfMean(xImage);      // u_A(x像)
        const uAXConvex = Data.stdErrorOfMean(xConvex);    // u_A(x凸)

        // 4. B类不确定度 (固定 0.5/sqrt(3) cm)
        const uB = 0.5 / Math.sqrt(3);   // 0.288675...

        // 5. 合成不确定度 for x像 和 x凸
        const uXImage = Math.hypot(uAXImage, uB);
        const uXConvex = Math.hypot(uAXConvex, uB);

        // 6. 焦距 f = -|avgXImage - avgXConvex| / 2
        const f = -Math.abs(avgXImage - avgXConvex) / 2;

        // 7. 焦距的不确定度 u(f) = sqrt( uXImage^2 + uXConvex^2 )   (根据文档公式，未除以2)
        const uf = Math.hypot(uXImage, uXConvex);

        // 8. 相对不确定度 (使用绝对值)
        const relU = f !== 0 ? uf / Math.abs(f) : 0;

        return {
            // 原始数组
            xLeft, xRight, xConvex,
            xImage,                          // 每次计算的x像
            avgXImage, avgXConvex,
            uAXImage, uAXConvex,
            uB,                               // 共用B类
            uXImage, uXConvex,
            f, uf, relU,
            // 保留用于详细过程
            xImageStr: xImage.map(v => v.toFixed(4)),
            xConvexStr: xConvex.map(v => v.toFixed(4))
        };
    }

    // ---------- 渲染详细计算过程 (模仿1-1的步骤风格) ----------
    function renderProcess(res) {
        // 使用 common.js 的工具格式化最终结果
        const [fDisplay, ufDisplay] = window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf);

        // 辅助: 生成残差平方和字符串 (用于展示A类计算)
        function formatResiduals(arr, mean) {
            return arr.map(v => {
                const diff = v - mean;
                return (diff < 0 ? `(${diff.toFixed(4)})` : diff.toFixed(4)) + '²';
            }).join(' + ');
        }

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 原始数据 (cm)</div>
            <div class="step-formula">$x_{\\text{像左}}$: ${res.xLeft.map(v => v.toFixed(2)).join(', ')}</div>
            <div class="step-formula">$x_{\\text{像右}}$: ${res.xRight.map(v => v.toFixed(2)).join(', ')}</div>
            <div class="step-formula">$x_{\\text{凸}}$: ${res.xConvex.map(v => v.toFixed(2)).join(', ')}</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 计算每次测量的 $x_{\\text{像}} = \\dfrac{x_{\\text{像左}}+x_{\\text{像右}}}{2}$</div>
            ${res.xImage.map((val, idx) => 
                `<div class="step-formula">第${idx+1}次: $x_{\\text{像}} = \\dfrac{${res.xLeft[idx].toFixed(2)} + ${res.xRight[idx].toFixed(2)}}{2} = ${val.toFixed(4)}$ cm</div>`
            ).join('')}
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 平均值 $\\bar{x}_{\\text{像}}$ 与 $\\bar{x}_{\\text{凸}}$</div>
            <div class="step-formula">$$\\bar{x}_{\\text{像}} = \\frac{${res.xImage.map(v => v.toFixed(4)).join('+')}}{5} = ${res.avgXImage.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\bar{x}_{\\text{凸}} = \\frac{${res.xConvex.map(v => v.toFixed(2)).join('+')}}{5} = ${res.avgXConvex.toFixed(4)}\\ \\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. A类不确定度</div>
            <div class="step-formula">$u_A(x_{\\text{像}}) = \\sqrt{\\frac{${formatResiduals(res.xImage, res.avgXImage)}}{5 \\times 4}} = ${res.uAXImage.toFixed(6)}$ cm</div>
            <div class="step-formula">$u_A(x_{\\text{凸}}) = \\sqrt{\\frac{${formatResiduals(res.xConvex, res.avgXConvex)}}{5 \\times 4}} = ${res.uAXConvex.toFixed(6)}$ cm</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. B类不确定度</div>
            <div class="step-formula">$$u_B = \\frac{0.5}{\\sqrt{3}} = ${res.uB.toFixed(6)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">(适用于 $x_{\\text{像}}$ 和 $x_{\\text{凸}}$)</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">6. 合成不确定度 $u(x_{\\text{像}})$ 与 $u(x_{\\text{凸}})$</div>
            <div class="step-formula">$u(x_{\\text{像}}) = \\sqrt{u_A^2(x_{\\text{像}}) + u_B^2} = \\sqrt{(${res.uAXImage.toFixed(6)})^2 + (${res.uB.toFixed(6)})^2} = ${res.uXImage.toFixed(6)}$ cm</div>
            <div class="step-formula">$u(x_{\\text{凸}}) = \\sqrt{u_A^2(x_{\\text{凸}}) + u_B^2} = \\sqrt{(${res.uAXConvex.toFixed(6)})^2 + (${res.uB.toFixed(6)})^2} = ${res.uXConvex.toFixed(6)}$ cm</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">7. 计算焦距 $f$</div>
            <div class="step-formula">$$f = -\\frac{|\\bar{x}_{\\text{像}} - \\bar{x}_{\\text{凸}}|}{2} = -\\frac{|${res.avgXImage.toFixed(4)} - ${res.avgXConvex.toFixed(4)}|}{2}$$</div>
            <div class="step-formula">差值绝对值 = ${Math.abs(res.avgXImage - res.avgXConvex).toFixed(4)}$ cm</div>
            <div class="step-result">$$f = ${res.f.toFixed(6)}\\ \\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">8. 焦距的不确定度 $u(f)$</div>
            <div class="step-formula">$$u(f) = \\sqrt{u^{2}(x_{\\text{像}}) + u^{2}(x_{\\text{凸}})} = \\sqrt{(${res.uXImage.toFixed(6)})^2 + (${res.uXConvex.toFixed(6)})^2}$$</div>
            <div class="step-result">$$u(f) = ${res.uf.toFixed(6)}\\ \\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">9. 相对不确定度</div>
            <div class="step-formula">$$\\frac{u(f)}{|f|} = \\frac{${res.uf.toFixed(6)}}{${Math.abs(res.f).toFixed(6)}} = ${res.relU.toFixed(6)}$$</div>
            <div class="step-result">相对不确定度 = ${(res.relU*100).toFixed(2)} %</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">10. 最终结果表示)</div>
            <div class="step-result" style="font-size:1.2rem;">$$f = (${fDisplay} \\pm ${ufDisplay})\\ \\mathrm{cm}$$</div>
            <div class="step-result">相对不确定度 $\\dfrac{u(f)}{|f|} = ${res.relU.toFixed(6)}$</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        // 触发MathJax渲染新添加的公式
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果卡片 ----------
    function displayResults(res) {
        // 使用公共函数格式化不确定度 (保留一位有效数字)
        const [fRounded, ufRounded] = window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf);
        document.getElementById('f_val').innerText = fRounded;
        document.getElementById('uf_val').innerText = ufRounded;
        document.getElementById('rel_uf_val').innerText = res.relU.toFixed(6);

        // 渲染详细过程
        renderProcess(res);

        // 显示结果区块
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 (与1-1一致) ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或含有无效数字，请确保5次测量的所有输入框均已填好 (x像左、x像右、x凸)');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            // 保存当前输入数据到localStorage (使用Storage模块)
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    // ---------- 仅保存数据 (不计算) ----------
    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 (生成表格、加载数据、绑定事件) ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成5行3列表格 (列: x像左, x像右, x凸), 前缀 m_
        TableGenerator.generateInputTable('mirror-table-container', {
            rows: 5,
            cols: 3,
            colHeaders: ['次数', 'x像左 (cm)', 'x像右 (cm)', 'x凸 (cm)'],
            rowHeaders: ['1', '2', '3', '4', '5'],
            prefix: 'm_',
            // 提供一组默认示例数据 (方便演示, 可自行修改)
            defaultValues: [
                40.25, 41.03, 42.50,   // 第1行: 左,右,凸
                40.30, 41.10, 42.48,
                40.22, 40.98, 42.55,
                40.28, 41.05, 42.52,
                40.26, 41.00, 42.49
            ]
        });

        // 尝试从本地加载之前保存的数据 (会覆盖默认值)
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 启用键盘导航 (列数为3)
        window.ExperimentUtils.KeyboardNav.init('#mirror-table-container', 3);

        // 深色模式初始化
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮事件
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);

        // 可选: 若本地有数据且希望自动计算? 不做自动计算, 保持与1-1一致: 需手动点击计算
        // 但可检查是否已有有效数据并静默填充 (已通过loadToInputs完成)
    });
})();
</script>
</body>
</html>