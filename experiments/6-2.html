<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 自准直法测量凸透镜焦距</title>
    <!-- 公共样式 (来自 1-1.html 的 style.css) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (来自 1-1.html 的 common.js) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (保持与 1-1 一致) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
    <style>
        /* 针对6-2实验微调表格最小宽度，保证显示美观 */
        #measurement-table-container .table-header,
        #measurement-table-container .table-row {
            min-width: 500px;
        }
        /* 结果卡片高度自适应微调 */
        .result-card {
            min-height: 120px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="page-title">自准直法测量凸透镜焦距</div>

    <!-- 实验要点提示 (包含公式及常量) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 仪器误差 $\Delta_{\text{仪}}$ 默认 $0.05\,\text{cm}$<br>
        • 透镜组位移 $\delta = 0.85\,\text{cm}$<br>
        • 测量5次：物位置 $x_A$，像位置 $x_L$ 正、$x_L$ 反<br>
        • 计算公式：
        $$x_L = \frac{x_{L正}+x_{L反}}{2},\quad f_i = |x_L - x_A| - \delta$$
        $$f = \frac{1}{5}\sum_{i=1}^{5} f_i$$
        $$u(f) = \frac{\Delta_{\text{仪}}\sqrt{2}}{\sqrt{15}},\quad \text{相对不确定度} = \frac{u(f)}{f}$$
    </div>

    <!-- 原始数据录入区 (无零点修正, 只有测量表格和两个参数) -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 顶部参数输入: δ 和 仪器误差 (模仿 1-1 的 top-input-group) -->
        <div class="top-input-group" style="margin-bottom: 1.5rem; gap: 2.5rem;">
            <div class="top-input">
                <label>$\delta$ (cm):</label>
                <input type="number" id="delta" class="save-input cell-input" step="0.01" value="0.85">
            </div>
            <div class="top-input">
                <label>$\Delta_{\text{仪}}$ (cm):</label>
                <input type="number" id="instrumentErr" class="save-input cell-input" step="0.01" value="0.05">
            </div>
        </div>

        <!-- 测量表格容器 (5行3列: xA, xL正, xL反) -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">测量数据 (5次)</div>
            <div id="measurement-table-container" class="data-table"></div>
        </div>
    </div>

    <!-- 操作按钮组 (与 1-1 完全一致) -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 (焦距, 不确定度, 相对不确定度) -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">焦距 $f$ (cm)</div><div class="result-value" id="f_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(f)$ (cm)</div><div class="result-value" id="uf_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(f)/f$</div><div class="result-value" id="rel_uf_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 (仿 1-1 逐步推导) -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 (与 1-1 相同) -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '6-2';   // 独立存储键值

    // ---------- 获取所有输入值 (无零点修正) ----------
    function getInputs() {
        const delta = parseFloat(document.getElementById('delta').value) || 0.85;
        const instrErr = parseFloat(document.getElementById('instrumentErr').value) || 0.05;

        // 读取测量表格数据 (id: m_1 ~ m_15, 按行优先: xA, xL正, xL反)
        const xA = [], xLz = [], xLf = [];
        for (let i = 0; i < 5; i++) {
            const baseIdx = i * 3;  // 每行3个数据
            const a = parseFloat(document.getElementById(`m_${baseIdx + 1}`)?.value);
            const z = parseFloat(document.getElementById(`m_${baseIdx + 2}`)?.value);
            const f = parseFloat(document.getElementById(`m_${baseIdx + 3}`)?.value);
            xA.push(isNaN(a) ? NaN : a);
            xLz.push(isNaN(z) ? NaN : z);
            xLf.push(isNaN(f) ? NaN : f);
        }

        return { delta, instrErr, xA, xLz, xLf };
    }

    // ---------- 数据有效性检查 (5组必须完整, δ和仪器误差为正) ----------
    function isValid(data) {
        if (data.delta <= 0 || data.instrErr <= 0) return false;
        const { xA, xLz, xLf } = data;
        for (let i = 0; i < 5; i++) {
            if (isNaN(xA[i]) || isNaN(xLz[i]) || isNaN(xLf[i])) return false;
        }
        return true;
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { delta, instrErr, xA, xLz, xLf } = data;
        const Data = window.ExperimentUtils.Data;

        // 计算每组的 xL = (xL正 + xL反)/2, |xA - xL|, fi = |xA - xL| - delta
        const xL = [];
        const absDiff = [];
        const fi = [];
        for (let i = 0; i < 5; i++) {
            const xL_i = (xLz[i] + xLf[i]) / 2;
            const diff_i = Math.abs(xL_i - xA[i]);
            const fi_i = diff_i - delta;
            xL.push(xL_i);
            absDiff.push(diff_i);
            fi.push(fi_i);
        }

        // 焦距 f = 平均值(fi)
        const f = Data.mean(fi);

        // 不确定度 u(f) = (instrErr * sqrt(2)) / sqrt(15)
        const uf = (instrErr * Math.sqrt(2)) / Math.sqrt(15);
        const relU = f !== 0 ? uf / Math.abs(f) : 0;

        return {
            // 原始数组
            xA, xLz, xLf,
            xL, absDiff, fi,
            delta, instrErr,
            f, uf, relU
        };
    }

    // ---------- 渲染详细计算过程 (仿 1-1 风格) ----------
    function renderProcess(res) {
        const { xA, xLz, xLf, xL, absDiff, fi, delta, instrErr, f, uf, relU } = res;

        // 辅助生成残差平方和字符串 (这里仅用于展示, 实际A类不确定度未使用, 但保留格式一致)
        const Data = window.ExperimentUtils.Data;
        const avgFi = f;

        // 为了与1-1风格统一，列出每次的fi及残差平方 (可选)
        const residualsFi = fi.map(v => (v - avgFi).toFixed(4)).join(', ');

        // 使用 common.js 的有效数字格式化
        const [fDisp, ufDisp] = window.ExperimentUtils.formatResultWithUncertainty(f, uf);

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 计算每组的 $x_L = (x_{L正}+x_{L反})/2$ 及 $|x_L - x_A|$</div>
            ${[0,1,2,3,4].map(i => `
                <div class="step-formula">$x_{L${i+1}} = \\frac{${xLz[i].toFixed(4)}+${xLf[i].toFixed(4)}}{2} = ${xL[i].toFixed(4)}$,  $|x_L - x_A| = |${xL[i].toFixed(4)}-${xA[i].toFixed(4)}| = ${absDiff[i].toFixed(4)}$</div>
            `).join('')}
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 计算每组的 $f_i = |x_L - x_A| - \\delta$</div>
            ${[0,1,2,3,4].map(i => `
                <div class="step-formula">$f_{${i+1}} = ${absDiff[i].toFixed(4)} - ${delta.toFixed(4)} = ${fi[i].toFixed(4)}$</div>
            `).join('')}
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 焦距 $f$ 计算</div>
            <div class="step-formula">$$\\bar{f} = \\frac{1}{5}\\left(${fi.map(v => v.toFixed(4)).join('+')}\\right) = ${f.toFixed(6)}\\,\\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 不确定度 $u(f)$ 计算</div>
            <div class="step-formula">单个 $f_i$ 的不确定度: $u(f_i) = \\sqrt{u(x_L)^2 + u(x_A)^2} = \\sqrt{\\left(\\frac{\\Delta_{\\text{仪}}}{\\sqrt{3}}\\right)^2 + \\left(\\frac{\\Delta_{\\text{仪}}}{\\sqrt{3}}\\right)^2} = \\frac{\\Delta_{\\text{仪}}\\sqrt{2}}{\\sqrt{3}}$</div>
            <div class="step-formula">$$u(f_i) = \\frac{${instrErr.toFixed(4)} \\times \\sqrt{2}}{\\sqrt{3}} = ${(instrErr*Math.sqrt(2/3)).toFixed(6)}\\,\\mathrm{cm}$$</div>
            <div class="step-formula">焦距 $f$ 为5次测量的平均值, 故 $u(f) = \\frac{u(f_i)}{\\sqrt{5}} = \\frac{${instrErr.toFixed(4)}\\sqrt{2}}{\\sqrt{15}} = ${uf.toFixed(6)}\\,\\mathrm{cm}$</div>
            <div class="step-result">$u(f) = ${uf.toFixed(6)}\,\\mathrm{cm}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 最终结果</div>
            <div class="step-result" style="font-size:1.2rem;">$f = (${fDisp} \\pm ${ufDisp})\\,\\mathrm{cm}$</div>
            <div class="step-result">相对不确定度 = $\\frac{u(f)}{f} = ${(relU*100).toFixed(2)}\\,\\%$</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果 (卡片) ----------
    function displayResults(res) {
        const [fRounded, ufRounded] = window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf);
        document.getElementById('f_val').innerText = fRounded;
        document.getElementById('uf_val').innerText = ufRounded;
        document.getElementById('rel_uf_val').innerText = res.relU.toFixed(6);
        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或格式错误，请确保5次测量的 xA, xL正, xL反 均已填满，且δ和仪器误差为正数');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            // 保存当前输入到 localStorage
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 (生成表格, 加载数据, 绑定事件) ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成测量表格: 5行, 3列 (xA, xL正, xL反), 列标题包含次数
        TableGenerator.generateInputTable('measurement-table-container', {
            rows: 5,
            cols: 3,
            colHeaders: ['次数', 'xA (cm)', 'xL正 (cm)', 'xL反 (cm)'],
            rowHeaders: ['1', '2', '3', '4', '5'],
            prefix: 'm_',
            // 默认示例数据 (合理焦距范围: 约14 cm)
            defaultValues: [
                45.20, 62.30, 62.50,   // 1: xA, xL正, xL反
                45.30, 62.40, 62.60,   // 2
                45.10, 62.20, 62.40,   // 3
                45.25, 62.35, 62.55,   // 4
                45.15, 62.25, 62.45    // 5
            ]
        });

        // 若本地无数据，使用默认值 (已通过 defaultValues 设置)
        if (!localStorage.getItem(APP_KEY)) {
            // 可设置δ和仪器误差默认 (已写在HTML中)
        }

        // 加载本地保存的数据 (会覆盖默认值)
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航 (列数为3)
        window.ExperimentUtils.KeyboardNav.init('#measurement-table-container', 3);

        // 深色模式 (与1-1相同)
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>