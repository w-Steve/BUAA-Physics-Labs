<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 共轭法测量凸透镜焦距</title>
    <!-- 公共样式 (与1-1相同) -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 (包含存储、表格生成、键盘导航、深色模式等) -->
    <script src="common.js"></script>
    <!-- MathJax 配置 (与1-1一致) -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">共轭法测量凸透镜焦距</div>

    <!-- 实验要点提示 (包含所有给定常数与公式) -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 物屏位置 $x_0$ (cm)，像屏位置 $x_3$ (cm) —— 直接读数，不需修正<br>
        • 透镜位移读数：$x_{1\text{左}}$、$x_{1\text{右}}$、$x_{2\text{左}}$、$x_{2\text{右}}$ (5次测量)<br>
        • 常数 $\delta = 0.85\,\text{cm}$ (透镜厚度)<br>
        &nbsp;&nbsp;$a = |x_1-x_2|$，$b = |x_3-x_0|-\delta$<br>
        • 焦距公式: $$f = \frac{b^{2} - a^{2}}{4b}$$<br>
    </div>

    <!-- 原始数据录入区 (严格仿照1-1结构) -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 基础参数: x0 和 x3 -->
        <div class="top-input-group" style="margin-bottom: 1rem; gap: 2.5rem;">
            <div class="top-input">
                <label>$x_0$ (cm):</label>
                <input type="number" id="x0" class="save-input cell-input" step="0.01" value="45.00">
            </div>
            <div class="top-input">
                <label>$x_3$ (cm):</label>
                <input type="number" id="x3" class="save-input cell-input" step="0.01" value="95.00">
            </div>
        </div>

        <!-- 测量数据表格 (5行4列，对应 x1左, x1右, x2左, x2右) -->
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">透镜位置测量 (5次)</div>
            <div id="measure-table-container" class="data-table"></div>
        </div>
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">焦距 $f$ (cm)</div><div class="result-value" id="f_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(f)$ (cm)</div><div class="result-value" id="uf_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(f)/f$</div><div class="result-value" id="rel_uf_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 (已按反馈精简: 无原始数据逐条展示, 偏导与合成合并) -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '6-1';   // 独立存储key

    // ---------- 获取所有输入值 ----------
    function getInputs() {
        const x0 = parseFloat(document.getElementById('x0').value) || 0;
        const x3 = parseFloat(document.getElementById('x3').value) || 0;

        // 读取测量表格数据 (id: m_1 ~ m_20, 5行4列)
        const left1 = [], right1 = [], left2 = [], right2 = [];
        for (let i = 0; i < 5; i++) {
            const base = i * 4;
            const v1 = parseFloat(document.getElementById(`m_${base+1}`)?.value);
            const v2 = parseFloat(document.getElementById(`m_${base+2}`)?.value);
            const v3 = parseFloat(document.getElementById(`m_${base+3}`)?.value);
            const v4 = parseFloat(document.getElementById(`m_${base+4}`)?.value);
            left1.push(isNaN(v1) ? NaN : v1);
            right1.push(isNaN(v2) ? NaN : v2);
            left2.push(isNaN(v3) ? NaN : v3);
            right2.push(isNaN(v4) ? NaN : v4);
        }

        return { x0, x3, left1, right1, left2, right2 };
    }

    // ---------- 数据有效性检查 ----------
    function isValid(data) {
        if (isNaN(data.x0) || isNaN(data.x3)) return false;
        const allVals = [...data.left1, ...data.right1, ...data.left2, ...data.right2];
        if (allVals.length !== 20 || allVals.some(v => isNaN(v))) return false;
        const bConst = Math.abs(data.x3 - data.x0) - 0.85;
        if (bConst <= 0) return false;
        return true;
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { x0, x3, left1, right1, left2, right2 } = data;
        const δ = 0.85;

        // 计算每次的 x1, x2, a
        const x1Arr = [], x2Arr = [], aArr = [];
        for (let i = 0; i < 5; i++) {
            const x1 = (left1[i] + right1[i]) / 2;
            const x2 = (left2[i] + right2[i]) / 2;
            x1Arr.push(x1);
            x2Arr.push(x2);
            aArr.push(Math.abs(x1 - x2));
        }
        const bConst = Math.abs(x3 - x0) - δ;   // 常数

        // 平均值
        const Data = window.ExperimentUtils.Data;
        const avgX1 = Data.mean(x1Arr);
        const avgX2 = Data.mean(x2Arr);
        const avgA = Data.mean(aArr);
        const avgB = bConst;

        // 不确定度
        const uAa = Data.stdErrorOfMean(aArr);          // a的A类
        const uB = 0.5 / Math.sqrt(3);                  // B类 (cm)
        const uA_total = Math.hypot(uAa, uB);            // a的合成
        const uBb = uB;                                   // b的B类

        // 偏导数
        const partialFA = -avgA / (2 * avgB);
        const partialFB = (avgA * avgA) / (4 * avgB * avgB) + 0.25;

        // 焦距
        const f = (avgB * avgB - avgA * avgA) / (4 * avgB);

        // 合成不确定度
        const uf = Math.sqrt( (partialFA * uA_total) ** 2 + (partialFB * uBb) ** 2 );
        const relU = f !== 0 ? uf / f : 0;

        return {
            avgX1, avgX2, avgA, avgB,
            uAa, uB, uA_total, uBb,
            partialFA, partialFB,
            f, uf, relU,
            x0, x3, δ,
            // 返回原始数组用于展示求和式子
            x1Arr, x2Arr, aArr
        };
    }

    // ---------- 渲染详细计算过程 (平均值计算展开求和式) ----------
    function renderProcess(res) {
        // 生成求和式子 (保留四位小数)
        const x1Sum = res.x1Arr.map(v => v.toFixed(4)).join('+');
        const x2Sum = res.x2Arr.map(v => v.toFixed(4)).join('+');
        const aSum = res.aArr.map(v => v.toFixed(4)).join('+');

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 平均值计算</div>
            <div class="step-formula">$$\\bar{x}_1 = \\frac{${x1Sum}}{5} = ${res.avgX1.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\bar{x}_2 = \\frac{${x2Sum}}{5} = ${res.avgX2.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\bar{a} = \\frac{${aSum}}{5} = ${res.avgA.toFixed(4)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">$$\\bar{b} = |x_3-x_0|-\\delta = |${res.x3.toFixed(4)}-${res.x0.toFixed(4)}|-${res.δ} = ${res.avgB.toFixed(4)}\\ \\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 不确定度分量</div>
            <div class="step-formula">$a$ 的A类不确定度: $u_A(a) = ${res.uAa.toFixed(6)}$ cm</div>
            <div class="step-formula">$a$ 的B类不确定度: $u_B = \\frac{0.5}{\\sqrt{3}} = ${res.uB.toFixed(6)}$ cm</div>
            <div class="step-formula">$a$ 的合成不确定度: $u(a) = \\sqrt{(${res.uAa.toFixed(6)})^2 + (${res.uB.toFixed(6)})^2} = ${res.uA_total.toFixed(6)}$ cm</div>
            <div class="step-formula">$b$ 的B类不确定度: $u(b) = \\frac{0.5}{\\sqrt{3}} = ${res.uBb.toFixed(6)}$ cm (无A类)</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 焦距 $f$ 计算</div>
            <div class="step-formula">$$f = \\frac{\\bar{b}^2 - \\bar{a}^2}{4\\bar{b}} = \\frac{(${res.avgB.toFixed(4)})^2 - (${res.avgA.toFixed(4)})^2}{4 \\times ${res.avgB.toFixed(4)}} = ${res.f.toFixed(6)}\\ \\mathrm{cm}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 偏导数与合成不确定度 $u(f)$</div>
            <div class="step-formula">偏导数 (使用平均值):</div>
            <div class="step-formula">$$\\frac{\\partial f}{\\partial a} = -\\frac{\\bar{a}}{2\\bar{b}} = -\\frac{${res.avgA.toFixed(4)}}{2\\times${res.avgB.toFixed(4)}} = ${res.partialFA.toFixed(6)}$$</div>
            <div class="step-formula">$$\\frac{\\partial f}{\\partial b} = \\frac{\\bar{a}^2}{4\\bar{b}^2}+\\frac{1}{4} = \\frac{(${res.avgA.toFixed(4)})^2}{4\\times(${res.avgB.toFixed(4)})^2}+0.25 = ${res.partialFB.toFixed(6)}$$</div>
            <div class="step-formula">合成不确定度:</div>
            <div class="step-formula">$$u(f) = \\sqrt{\\left(\\frac{\\partial f}{\\partial a}\\right)^2 u^2(a) + \\left(\\frac{\\partial f}{\\partial b}\\right)^2 u^2(b)}$$</div>
            <div class="step-formula">$$= \\sqrt{(${res.partialFA.toFixed(6)})^2 \\times (${res.uA_total.toFixed(6)})^2 + (${res.partialFB.toFixed(6)})^2 \\times (${res.uBb.toFixed(6)})^2} = ${res.uf.toFixed(6)}\\ \\mathrm{cm}$$</div>
            <div class="step-formula">相对不确定度 $\\frac{u(f)}{f} = \\frac{${res.uf.toFixed(6)}}{${res.f.toFixed(6)}} = ${res.relU.toFixed(6)}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 最终结果</div>
            <div class="step-result" style="font-size:1.2rem;">$f = (${window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf)[0]} \\pm ${window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf)[1]})\\ \\mathrm{cm}$</div>
            <div class="step-result">相对不确定度 = ${(res.relU*100).toFixed(2)} %</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果卡片 ----------
    function displayResults(res) {
        const [fRounded, ufRounded] = window.ExperimentUtils.formatResultWithUncertainty(res.f, res.uf);
        document.getElementById('f_val').innerText = fRounded;
        document.getElementById('uf_val').innerText = ufRounded;
        document.getElementById('rel_uf_val').innerText = res.relU.toFixed(6);

        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或格式错误，请确保所有测量值已填满 (5次) 且 |x₃-x₀| > 0.85 cm');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成测量表格: 5行, 4列 (左1,右1,左2,右2)
        TableGenerator.generateInputTable('measure-table-container', {
            rows: 5,
            cols: 4,
            colHeaders: ['次数', 'x₁左 (cm)', 'x₁右 (cm)', 'x₂左 (cm)', 'x₂右 (cm)'],
            rowHeaders: ['1', '2', '3', '4', '5'],
            prefix: 'm_',
            // 提供一组合理的默认值 (单位cm)
            defaultValues: [
                45.50, 46.50, 65.20, 66.20,   // 第1次
                45.52, 46.52, 65.18, 66.18,   // 第2次
                45.48, 46.48, 65.22, 66.22,   // 第3次
                45.51, 46.51, 65.19, 66.19,   // 第4次
                45.49, 46.49, 65.21, 66.21    // 第5次
            ]
        });

        // 加载保存的数据 (会覆盖默认值)
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航 (表格列数为4)
        window.ExperimentUtils.KeyboardNav.init('#measure-table-container', 4);

        // 深色模式
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>