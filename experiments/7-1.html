<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 自组电位差计测量干电池电动势</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">自组电位差计测量干电池电动势</div>

    <!-- 实验要点提示 -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • 标准电池 $E_{20}$ (V), 温度 $t$ (°C) 计算 $E_N$：<br>
        $$E_N = E_{20} - 3.99\times10^{-5}(t-20) - 0.94\times10^{-6}(t-20)^2 + 9\times10^{-9}(t-20)^3$$<br>
        • 被测电池 $E_x = \dfrac{E_N}{R_1}\cdot R_1'$  (工作电流 $I_0=1\,\mathrm{mA}$)<br>
        • 电阻箱误差 $\Delta R_k = R_{0k} + \sum a_{ik}\%\cdot R_{ik}$，$u(R_k)=\Delta R_k/\sqrt{3}$<br>
        • $u(E_{x0}) = \dfrac{E_{x0}/10000 + 10^{-6}}{\sqrt{3}}$，相对误差 $\dfrac{E_x-E_{x0}}{E_{x0}}\times100\%$
    </div>

    <!-- 原始数据录入区 -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 基本参数 E20, t, Ex0 -->
        <div class="top-input-group" style="margin-bottom: 1rem;">
            <div class="top-input"><label>$E_{20}$ (V):</label><input type="number" id="e20" class="save-input cell-input" step="0.00001" value="1.01860"></div>
            <div class="top-input"><label>$t$ (°C):</label><input type="number" id="t" class="save-input cell-input" step="0.1" value="20.0"></div>
            <div class="top-input"><label>$E_{x0}$ (V):</label><input type="number" id="ex0" class="save-input cell-input" step="0.00001" value="1.50000"></div>
        </div>

        <!-- 电阻值 R1, R2, R1', R2' 表格 -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">电阻值 (Ω)</div>
            <div id="resistance-table" class="data-table"></div>
        </div>

        <!-- 残余误差 R01, R02 -->
        <div class="top-input-group" style="margin-bottom: 2rem;">
            <div class="top-input"><label>$R_{01}$ (Ω):</label><input type="number" id="r01" class="save-input cell-input" step="0.001" value="0.000"></div>
            <div class="top-input"><label>$R_{02}$ (Ω):</label><input type="number" id="r02" class="save-input cell-input" step="0.001" value="0.000"></div>
        </div>

        <!-- R1电阻箱准确度等级 -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">R1电阻箱准确度等级 $a_{i1}$ (%)</div>
            <div id="r1-acc-table" class="data-table"></div>
        </div>

        <!-- R2电阻箱准确度等级 -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">R2电阻箱准确度等级 $a_{i2}$ (%)</div>
            <div id="r2-acc-table" class="data-table"></div>
        </div>
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px,1fr));">
            <div class="result-card"><div class="result-label">$E_N$ (V)</div><div class="result-value" id="en_val">—</div></div>
            <div class="result-card"><div class="result-label">$E_x$ (V)</div><div class="result-value" id="ex_val">—</div></div>
            <div class="result-card"><div class="result-label">$u(E_x)$ (V)</div><div class="result-value" id="uex_val">—</div></div>
            <div class="result-card"><div class="result-label">$u(E_{x0})$ (V)</div><div class="result-value" id="uex0_val">—</div></div>
            <div class="result-card"><div class="result-label">相对误差 %</div><div class="result-value" id="rel_err_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '7-1';

    function getInputs() {
        const e20 = parseFloat(document.getElementById('e20').value);
        const t = parseFloat(document.getElementById('t').value);
        const ex0 = parseFloat(document.getElementById('ex0').value);
        const r1 = parseFloat(document.getElementById('r_1')?.value);
        const r2 = parseFloat(document.getElementById('r_2')?.value);
        const r1p = parseFloat(document.getElementById('r_3')?.value);
        const r2p = parseFloat(document.getElementById('r_4')?.value);
        const r01 = parseFloat(document.getElementById('r01').value) || 0;
        const r02 = parseFloat(document.getElementById('r02').value) || 0;
        const a1_1000 = parseFloat(document.getElementById('a1_1')?.value);
        const a1_100  = parseFloat(document.getElementById('a1_2')?.value);
        const a1_10   = parseFloat(document.getElementById('a1_3')?.value);
        const a1_1    = parseFloat(document.getElementById('a1_4')?.value);
        const a1_01   = parseFloat(document.getElementById('a1_5')?.value);
        const a2_1000 = parseFloat(document.getElementById('a2_1')?.value);
        const a2_100  = parseFloat(document.getElementById('a2_2')?.value);
        const a2_10   = parseFloat(document.getElementById('a2_3')?.value);
        const a2_1    = parseFloat(document.getElementById('a2_4')?.value);
        const a2_01   = parseFloat(document.getElementById('a2_5')?.value);

        return {
            e20, t, ex0,
            r1, r2, r1p, r2p,
            r01, r02,
            a1: [a1_1000, a1_100, a1_10, a1_1, a1_01],
            a2: [a2_1000, a2_100, a2_10, a2_1, a2_01]
        };
    }

    function isValid(data) {
        const required = [
            data.e20, data.t, data.ex0,
            data.r1, data.r2, data.r1p, data.r2p,
            data.r01, data.r02,
            ...data.a1, ...data.a2
        ];
        if (required.some(v => isNaN(v))) return false;
        if (data.r1 <= 0 || data.r2 <= 0 || data.r1p <= 0 || data.r2p <= 0) return false;
        if (data.a1.some(v => v < 0) || data.a2.some(v => v < 0)) return false;
        return true;
    }

    function decomposeResistance(R) {
        const R_abs = Math.abs(R);
        const r1000 = Math.floor(R_abs / 1000) * 1000;
        const r100  = Math.floor((R_abs % 1000) / 100) * 100;
        const r10   = Math.floor((R_abs % 100) / 10) * 10;
        const r1    = Math.floor(R_abs % 10);
        const frac = Math.round((R_abs - Math.floor(R_abs)) * 10) / 10;
        const r01 = frac;
        return [r1000, r100, r10, r1, r01];
    }

    function computeResistanceUncertainty(R, R0, accArr) {
        const discs = decomposeResistance(R);
        let deltaR = R0;
        for (let i = 0; i < 5; i++) {
            deltaR += (accArr[i] / 100) * discs[i];
        }
        const uR = deltaR / Math.sqrt(3);
        return { deltaR, uR, discs };
    }

    function compute(data) {
        const { e20, t, ex0, r1, r2, r1p, r2p, r01, r02, a1, a2 } = data;
        const dt = t - 20;
        const EN = e20 - 3.99e-5 * dt - 0.94e-6 * dt * dt + 9e-9 * dt * dt * dt;
        const Ex = (EN / r1) * r1p;

        const res1 = computeResistanceUncertainty(r1, r01, a1);
        const res2 = computeResistanceUncertainty(r2, r02, a2);
        const res1p = computeResistanceUncertainty(r1p, r01, a1);
        const res2p = computeResistanceUncertainty(r2p, r02, a2);

        const uR1 = res1.uR, uR2 = res2.uR, uR1p = res1p.uR, uR2p = res2p.uR;

        const termA = (1/r1 - 1/(r1 + r2)) ** 2 * uR1 ** 2;
        const termB = (uR2 / (r1 + r2)) ** 2;
        const termC = (1/r1p - 1/(r1p + r2p)) ** 2 * uR1p ** 2;
        const termD = (uR2p / (r1p + r2p)) ** 2;
        const uEx = Ex * Math.sqrt(termA + termB + termC + termD);

        const uEx0 = (ex0 / 10000 + 1e-6) / Math.sqrt(3);
        const relError = ((Ex - ex0) / ex0) * 100;

        return {
            EN, Ex, uEx, uEx0, relError,
            r1, r2, r1p, r2p, ex0,
            res1, res2, res1p, res2p,
            uR1, uR2, uR1p, uR2p,
            a1, a2, r01, r02, e20, t, dt
        };
    }

    function renderProcess(res) {
        const discsR1 = res.res1.discs.map(v => v.toFixed(3)).join(', ');
        const discsR2 = res.res2.discs.map(v => v.toFixed(3)).join(', ');
        const discsR1p = res.res1p.discs.map(v => v.toFixed(3)).join(', ');
        const discsR2p = res.res2p.discs.map(v => v.toFixed(3)).join(', ');
        const a1str = res.a1.map(v => v.toFixed(3) + '\\%').join(', ');
        const a2str = res.a2.map(v => v.toFixed(3) + '\\%').join(', ');

        const [exStr, uexStr] = window.ExperimentUtils.formatResultWithUncertainty(res.Ex, res.uEx);
        const uex0Obj = window.ExperimentUtils.formatResultWithUncertainty(res.uEx0, res.uEx0, true);
        const uex0Display = uex0Obj.uncertainty;

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 标准电池电动势 $E_N$</div>
            <div class="step-formula">$t -20 = ${res.dt.toFixed(4)}$</div>
            <div class="step-formula">$$E_N = E_{20} - 3.99\\times10^{-5}(t-20) - 0.94\\times10^{-6}(t-20)^2 + 9\\times10^{-9}(t-20)^3$$</div>
            <div class="step-formula">$$ = ${res.e20.toFixed(6)} - 3.99\\times10^{-5}\\times${res.dt.toFixed(4)} - 0.94\\times10^{-6}\\times${(res.dt**2).toFixed(6)} + 9\\times10^{-9}\\times${(res.dt**3).toFixed(8)}$$</div>
            <div class="step-result">$E_N = ${res.EN.toFixed(6)}\\,\\mathrm{V}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 被测电池电动势 $E_x$</div>
            <div class="step-formula">$$E_x = \\frac{E_N}{R_1}R_1' = \\frac{${res.EN.toFixed(6)}}{${res.r1.toFixed(3)}} \\times ${res.r1p.toFixed(3)}$$</div>
            <div class="step-result">$E_x = ${res.Ex.toFixed(6)}\\,\\mathrm{V}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 电阻箱误差 $\\Delta R$ 与 $u(R)$)</div>
            <div class="step-formula">$R_1 = ${res.r1.toFixed(3)}\\,\\Omega$，分解盘示值 (1000,100,10,1,0.1): $[${discsR1}]$</div>
            <div class="step-formula">准确度等级 $a_{i1}=[${a1str}]$，残余误差 $R_{01}=${res.r01.toFixed(3)}\\,\\Omega$</div>
            <div class="step-formula">$$\\Delta R_1 = R_{01} + \\sum a_{i1}\\% \\cdot R_{i1} = ${res.r01.toFixed(3)} + (${res.a1.map((a,i) => `(${a/100}\\times${res.res1.discs[i].toFixed(3)})`).join('+')})$$</div>
            <div class="step-formula">$\\Delta R_1 = ${res.res1.deltaR.toFixed(6)}\\,\\Omega$，$u(R_1)=\\Delta R_1/\\sqrt3 = ${res.uR1.toFixed(6)}\\,\\Omega$</div>
            <div class="step-formula">$R_2 = ${res.r2.toFixed(3)}\\,\\Omega$，分解: $[${discsR2}]$，$a_{i2}=[${a2str}]$，$R_{02}=${res.r02.toFixed(3)}\\,\\Omega$</div>
            <div class="step-formula">$\\Delta R_2 = ${res.res2.deltaR.toFixed(6)}\\,\\Omega$，$u(R_2)=${res.uR2.toFixed(6)}\\,\\Omega$</div>
            <div class="step-formula">$R_1'$ 同R1箱: $\\Delta R_1' = ${res.res1p.deltaR.toFixed(6)}\\,\\Omega$，$u(R_1')=${res.uR1p.toFixed(6)}\\,\\Omega$</div>
            <div class="step-formula">$R_2'$ 同R2箱: $\\Delta R_2' = ${res.res2p.deltaR.toFixed(6)}\\,\\Omega$，$u(R_2')=${res.uR2p.toFixed(6)}\\,\\Omega$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 合成不确定度 $u(E_x)$</div>
            <div class="step-formula">$$u(E_x) = E_x\\sqrt{\\left(\\frac{1}{R_1}-\\frac{1}{R_1+R_2}\\right)^2 u^2(R_1) + \\left(\\frac{u(R_2)}{R_1+R_2}\\right)^2 + \\left(\\frac{1}{R_1'}-\\frac{1}{R_1'+R_2'}\\right)^2 u^2(R_1') + \\left(\\frac{u(R_2')}{R_1'+R_2'}\\right)^2}$$</div>
            <div class="step-formula">第一项: $\\left(\\frac{1}{${res.r1.toFixed(3)}}-\\frac{1}{${(res.r1+res.r2).toFixed(3)}}\\right)^2 \\times (${res.uR1.toFixed(6)})^2 = ${((1/res.r1 - 1/(res.r1+res.r2))**2 * res.uR1**2).toExponential(4)}$</div>
            <div class="step-formula">第二项: $\\left(\\frac{${res.uR2.toFixed(6)}}{${(res.r1+res.r2).toFixed(3)}}\\right)^2 = ${((res.uR2/(res.r1+res.r2))**2).toExponential(4)}$</div>
            <div class="step-formula">第三项: $\\left(\\frac{1}{${res.r1p.toFixed(3)}}-\\frac{1}{${(res.r1p+res.r2p).toFixed(3)}}\\right)^2 \\times (${res.uR1p.toFixed(6)})^2 = ${((1/res.r1p - 1/(res.r1p+res.r2p))**2 * res.uR1p**2).toExponential(4)}$</div>
            <div class="step-formula">第四项: $\\left(\\frac{${res.uR2p.toFixed(6)}}{${(res.r1p+res.r2p).toFixed(3)}}\\right)^2 = ${((res.uR2p/(res.r1p+res.r2p))**2).toExponential(4)}$</div>
            <div class="step-formula">根号内和 = ${( (1/res.r1 - 1/(res.r1+res.r2))**2 * res.uR1**2 + (res.uR2/(res.r1+res.r2))**2 + (1/res.r1p - 1/(res.r1p+res.r2p))**2 * res.uR1p**2 + (res.uR2p/(res.r1p+res.r2p))**2 ).toExponential(6) }</div>
            <div class="step-formula">$u(E_x) = ${res.Ex.toFixed(6)} \\times \\sqrt{\\cdots} = ${res.uEx.toFixed(6)}\\,\\mathrm{V}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 参考值不确定度 $u(E_{x0})$</div>
            <div class="step-formula">$$u(E_{x0}) = \\frac{E_{x0}/10000 + 10^{-6}}{\\sqrt{3}} = \\frac{${res.ex0.toFixed(6)}/10000 + 1\\times10^{-6}}{\\sqrt{3}} = ${res.uEx0.toFixed(6)}\\,\\mathrm{V}$$</div>
            <div class="step-result">修约后 $u(E_{x0}) = ${uex0Display}\\,\\mathrm{V}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">6. 相对误差</div>
            <div class="step-formula">$$\\frac{E_x - E_{x0}}{E_{x0}}\\times 100\\% = \\frac{${res.Ex.toFixed(6)} - ${res.ex0.toFixed(6)}}{${res.ex0.toFixed(6)}}\\times100 = ${res.relError.toFixed(4)}\\%$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">7. 最终结果athrm{V}$，$u(E_x) = ${uexStr}\\,\\mathrm{V}$</div>
            <div class="step-formula">$u(E_{x0}) = ${uex0Display}\\,\\mathrm{V}$</div>
            <div class="step-result">相对误差 = ${res.relError.toFixed(4)}\\%</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    function displayResults(res) {
        const [exDisplay, uexDisplay] = window.ExperimentUtils.formatResultWithUncertainty(res.Ex, res.uEx);
        const uex0Obj = window.ExperimentUtils.formatResultWithUncertainty(res.uEx0, res.uEx0, true);
        const uex0Display = uex0Obj.uncertainty;

        document.getElementById('en_val').innerText = res.EN.toFixed(6);
        document.getElementById('ex_val').innerText = exDisplay;
        document.getElementById('uex_val').innerText = uexDisplay;
        document.getElementById('uex0_val').innerText = uex0Display;
        document.getElementById('rel_err_val').innerText = res.relError.toFixed(4) + ' %';

        renderProcess(res);
        document.getElementById('resultMain').style.display = 'block';
        document.getElementById('processSection').style.display = 'block';
    }

    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或有误，请确保所有数值已填写且为正 (准确度可为零)');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        TableGenerator.generateInputTable('resistance-table', {
            rows: 1,
            cols: 4,
            colHeaders: ['R1 (Ω)', 'R2 (Ω)', "R1' (Ω)", "R2' (Ω)"],
            rowHeaders: ['数值'],
            prefix: 'r_',
            defaultValues: [1500.0, 500.0, 1200.0, 400.0]
        });

        TableGenerator.generateInputTable('r1-acc-table', {
            rows: 1,
            cols: 5,
            colHeaders: ['','1000', '100', '10', '1', '0.1'],
            rowHeaders: ['a_i1 (%)'],
            prefix: 'a1_',
            defaultValues: [0.1, 0.1, 0.1, 0.1, 0.2]
        });

        TableGenerator.generateInputTable('r2-acc-table', {
            rows: 1,
            cols: 5,
            colHeaders: ['','1000', '100', '10', '1', '0.1'],
            rowHeaders: ['a_i2 (%)'],
            prefix: 'a2_',
            defaultValues: [0.1, 0.1, 0.1, 0.1, 0.2]
        });

        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);
        window.ExperimentUtils.KeyboardNav.init('#resistance-table', 4);
        window.ExperimentUtils.KeyboardNav.init('#r1-acc-table', 5);
        window.ExperimentUtils.KeyboardNav.init('#r2-acc-table', 5);
        window.ExperimentUtils.ThemeManager.init();

        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>