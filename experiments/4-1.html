<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 双电桥法测量铜棒电阻率</title>
    <!-- 公共样式 -->
    <link rel="stylesheet" href="style.css">
    <!-- 公共工具库 -->
    <script src="common.js"></script>
    <!-- MathJax 配置 -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">双电桥法测量铜棒电阻率</div>

    <!-- 实验要点提示 -->
    <div class="tip-box">
        <strong>Tips</strong><br>
        • $R_N $为标准电阻<br>
        • 计算公式：
        $$\overline{R} = \frac{R_正 + R_负}{2},\quad 
          R_x = \frac{R_N}{R_1}\overline{R},\quad 
          l = \frac{\pi D^2}{4\rho}R_x$$<br>
        • 令 $x = R_x$, $y = l$，作一元线性回归得斜率 $\hat{b}$，则
        $$\rho = \frac{\pi \bar{D}^2}{4\hat{b}}$$
    </div>

    <!-- 原始数据录入区 -->
    <div class="section">
        <div class="section-title">原始数据录入</div>

        <!-- 标准电阻 R_N -->
        <div class="top-input-group" style="margin-bottom: 1rem;">
            <div class="top-input">
                <label>$R_N$ ($\Omega$):</label>
                <input type="number" id="RN" class="save-input cell-input" step="0.000001" value="0.001">
            </div>
        </div>

        <!-- 电桥测量表格容器 (8行4列) -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">电桥测量数据</div>
            <div id="bridge-table-container" class="data-table"></div>
        </div>

        <!-- 直径测量表格容器 (8行1列) -->
        <div style="margin-bottom: 2rem;">
            <div style="font-weight: 500; margin-bottom: 0.5rem;">直径 $D_i$ 测量 (mm)</div>
            <div id="diameter-table-container" class="data-table"></div>
        </div>
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果卡片 -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">电阻率 $\rho$ ($\Omega\cdot m$)</div><div class="result-value" id="rho_val">—</div></div>
            <div class="result-card"><div class="result-label">合成不确定度 $u(\rho)$ ($\Omega\cdot m$)</div><div class="result-value" id="urho_val">—</div></div>
            <div class="result-card"><div class="result-label">相对不确定度 $u(\rho)/\rho$</div><div class="result-value" id="rel_urho_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">开源项目禁止商用 ｜ 自行核对计算数据</div>
</div>

<script>
(function() {
    const APP_KEY = '4-1';

    // ---------- 获取所有输入值 ----------
    function getInputs() {
        const RN = parseFloat(document.getElementById('RN').value) || 0.001;

        // 读取电桥测量表格数据 (8行4列, 行优先编号)
        const length_mm = [];      // l (mm)
        const R1R2 = [];           // R₁和R₂ (Ω)
        const Rpos = [];           // R_正 (Ω)
        const Rneg = [];           // R_负 (Ω)
        for (let i = 0; i < 8; i++) {
            const base = i * 4 + 1;
            const lVal = parseFloat(document.getElementById(`bridge_${base}`)?.value);
            const r1Val = parseFloat(document.getElementById(`bridge_${base+1}`)?.value);
            const rpVal = parseFloat(document.getElementById(`bridge_${base+2}`)?.value);
            const rnVal = parseFloat(document.getElementById(`bridge_${base+3}`)?.value);
            length_mm.push(isNaN(lVal) ? NaN : lVal);
            R1R2.push(isNaN(r1Val) ? NaN : r1Val);
            Rpos.push(isNaN(rpVal) ? NaN : rpVal);
            Rneg.push(isNaN(rnVal) ? NaN : rnVal);
        }

        // 读取直径测量表格数据 (8行1列)
        const D_mm = [];
        for (let i = 0; i < 8; i++) {
            const dVal = parseFloat(document.getElementById(`diam_${i+1}`)?.value);
            D_mm.push(isNaN(dVal) ? NaN : dVal);
        }

        return { RN, length_mm, R1R2, Rpos, Rneg, D_mm };
    }

    // ---------- 数据有效性检查 ----------
    function isValid(data) {
        if (isNaN(data.RN) || data.RN <= 0) return false;
        const arrays = [data.length_mm, data.R1R2, data.Rpos, data.Rneg, data.D_mm];
        for (let arr of arrays) {
            if (arr.length !== 8 || arr.some(v => isNaN(v))) return false;
        }
        return true;
    }

    // ---------- 核心计算 ----------
    function compute(data) {
        const { RN, length_mm, R1R2, Rpos, Rneg, D_mm } = data;
        const n = 8;
        const Data = window.ExperimentUtils.Data;

        // 计算 R̄ 和 R_x
        const Rbar = [];
        const Rx = [];
        for (let i = 0; i < n; i++) {
            const rbar = (Rpos[i] + Rneg[i]) / 2;
            const rx = (RN / R1R2[i]) * rbar;
            Rbar.push(rbar);
            Rx.push(rx);
        }

        // 转换单位：长度 mm → m, 直径 mm → m
        const l_m = length_mm.map(v => v / 1000);
        const D_m = D_mm.map(v => v / 1000);
        const D_avg_m = Data.mean(D_m);
        const D_avg_mm = D_avg_m * 1000;

        // 线性回归：x = Rx (Ω), y = l (m)
        const reg = Data.linearRegression(Rx, l_m);
        const slope = reg.slope;        // b̂ (m/Ω)
        const intercept = reg.intercept; // â (m)
        const r = reg.r;

        // 电阻率 ρ = (π * D_avg²) / (4 * slope)  单位 Ω·m
        const rho = (Math.PI * D_avg_m * D_avg_m) / (4 * slope);

        // ---------- 不确定度计算 ----------

        // 1. 直径 D 的不确定度 (单位：m, 但显示用 mm)
        const uDA_m = Data.stdErrorOfMean(D_m);                     // A类 (m)
        const uDA_mm = uDA_m * 1000;
        const uDB_mm = 0.02 / Math.sqrt(3);                         // B类 (mm)
        const uDB_m = uDB_mm / 1000;
        const uD_m = Math.hypot(uDA_m, uDB_m);                      // 合成 (m)
        const uD_mm = uD_m * 1000;

        // 2. 斜率 b̂ 的不确定度
        // A类: uA(b̂) = b̂ * sqrt( (1/(n-2)) * (1/r² - 1) )
        let uBA = 0;
        if (r !== 0 && n > 2) {
            uBA = slope * Math.sqrt((1 / (n - 2)) * ((1 / (r * r)) - 1));
        }

        // B类: uB(b̂) ≈ b̂ * sqrt( (2*uB(D)/D)² + (uB(Rx)/Rx̄)² + (uB(l)/l̄)² )
        // uB(D) 已得 uDB_m
        // uB(Rx) = (0.05% * Rx̄) / √3
        const Rx_avg = Data.mean(Rx);
        const uRxB = (0.0005 * Rx_avg) / Math.sqrt(3);               // Ω

        // uB(l) = 0.05 mm / √3 = 0.00005 m / √3
        const ulB_mm = 0.05 / Math.sqrt(3);
        const ulB_m = ulB_mm / 1000;

        const l_avg_m = Data.mean(l_m);
        const l_avg_mm = l_avg_m * 1000;

        const termD = (2 * uDB_m / D_avg_m) ** 2;
        const termRx = (uRxB / Rx_avg) ** 2;
        const termL = (ulB_m / l_avg_m) ** 2;
        const uBB = slope * Math.sqrt(termD + termRx + termL);      // B类 (m/Ω)

        const uB_m = Math.hypot(uBA, uBB);                           // 合成 u(b̂) (m/Ω)

        // 3. 电阻率 ρ 的不确定度
        const relTermD = (2 * uD_m / D_avg_m) ** 2;
        const relTermB = (uB_m / slope) ** 2;
        const relU = Math.sqrt(relTermD + relTermB);
        const uRho = rho * relU;

        // 收集所有需要显示的中间量
        return {
            n,
            RN,
            // 原始数组 (用于展示)
            length_mm, R1R2, Rpos, Rneg, D_mm,
            Rbar, Rx,
            // 平均值 (单位统一: 长度和直径均保留 mm 用于显示, 但回归用的米单独存)
            Rx_avg,
            l_avg_mm,
            D_avg: D_avg_mm,
            // 线性回归结果 (包含 sumX, sumY, sumXX, sumYY, sumXY 等)
            reg,
            // 不确定度分量 (保留常用单位)
            uDA_mm, uDB_mm, uD_mm,
            uBA, uBB, uB_m,
            uRxB,
            ulB_mm,
            // 最终结果
            rho, uRho, relU,
            // 额外需要用于详细过程的转换值 (注意加入 uDA_m)
            uDA_m,
            D_avg_m,
            l_avg_m,
            uDB_m,
            ulB_m,
            uD_m
        };
    }

    // ---------- 辅助函数：科学计数法保留三位小数，安全处理非法输入 ----------
    function toExp3(x) {
        if (x === undefined || x === null || isNaN(x) || !isFinite(x)) return '—';
        return x.toExponential(3);
    }
    // ---------- 辅助函数：将修约后的字符串转换为科学计数法，保留原有效数字位数 ----------
    function toSciAfterRounding(roundedStr) {
        if (roundedStr === '—' || roundedStr === '') return roundedStr;
        // 处理可能的正负号
        let str = roundedStr.trim();
        let sign = '';
        if (str.startsWith('-')) {
            sign = '-';
            str = str.substring(1);
        } else if (str.startsWith('+')) {
            str = str.substring(1);
        }
        // 统计有效数字位数（只考虑普通十进制，不含指数）
        let significantDigits = 0;
        let seenNonZero = false;
        for (let i = 0; i < str.length; i++) {
            const ch = str[i];
            if (ch >= '1' && ch <= '9') {
                seenNonZero = true;
                significantDigits++;
            } else if (ch === '0') {
                if (seenNonZero) significantDigits++;
            } else if (ch === '.') {
                // 忽略小数点
            } else {
                // 出现其他字符（如 e），说明已经是科学计数法，直接返回原字符串
                return roundedStr;
            }
        }
        const num = parseFloat(roundedStr);
        if (isNaN(num)) return roundedStr;
        return sign + num.toExponential(significantDigits);
    }


    // ---------- 渲染详细计算过程 ----------
    function renderProcess(res) {
        // 重新计算修约后的科学计数法字符串
        const fmt = window.ExperimentUtils.formatResultWithUncertainty(res.rho, res.uRho, true);
        const rhoSci = toSciAfterRounding(fmt.value);
        const uSci = toSciAfterRounding(fmt.uncertainty);
        // 然后在 step7 中使用 rhoSci 和 uSci
        const Data = window.ExperimentUtils.Data;
        // 计算残差平方和的值 (用于显示)
        const sumSqD = res.D_mm.reduce((acc, v) => acc + (v - res.D_avg) ** 2, 0);

        // 生成直径残差平方展开式
        const devSqDExpr = res.D_mm.map((v, i) => `(${v.toFixed(4)} - ${res.D_avg.toFixed(4)})^2`).join(' + ');

        // 生成中间结果表格行 (使用.output-table，外层有滚动包装)
        const tableRows = res.Rx.map((rx, i) => `
            <tr>
                <td>${i+1}</td>
                <td>${res.length_mm[i].toFixed(2)}</td>
                <td>${toExp3(res.R1R2[i])}</td>
                <td>${toExp3(res.Rpos[i])}</td>
                <td>${toExp3(res.Rneg[i])}</td>
                <td>${toExp3(res.Rbar[i])}</td>
                <td>${toExp3(res.Rx[i])}</td>
                <td>${res.D_mm[i].toFixed(4)}</td>
            </tr>
        `).join('');

        const html = `
        <div class="calculation-step">
            <div class="step-title">1. 原始数据与中间量 </div>
            <div class="step-formula">标准电阻 $R_N = ${toExp3(res.RN)}\\,\\Omega$</div>
            <div class="output-table-wrapper">
                <table class="output-table">
                    <thead>
                        <tr>
                            <th>$i$</th><th>$l$ (mm)</th><th>$R_1,R_2$ ($\\Omega$)</th><th>$R_正$ ($\\Omega$)</th><th>$R_负$ ($\\Omega$)</th><th>$\\overline{R}$ ($\\Omega$)</th><th>$R_x$ ($\\Omega$)</th><th>$D_i$ (mm)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="calculation-step">
            <div class="step-title">2. 直径 $D$ 的平均值与不确定度</div>
            <div class="step-formula">$$\\bar{D} = \\frac{1}{8}\\sum_{i=1}^8 D_i = \\frac{${res.D_mm.map(v => v.toFixed(4)).join('+')}}{8} = ${res.D_avg.toFixed(4)}\\ \\mathrm{mm}$$</div>
            <div class="step-formula">A类不确定度：$u_A(D) = \\sqrt{\\frac{\\sum_{i=1}^8 (D_i - \\bar{D})^2}{8\\times7}}$</div>
            <div class="step-formula">$$\\sum (D_i - \\bar{D})^2 = ${devSqDExpr} = ${sumSqD.toFixed(6)}\\ \\mathrm{mm}^2$$</div>
            <div class="step-formula">$$u_A(D) = \\sqrt{\\frac{${sumSqD.toFixed(6)}}{56}} = ${res.uDA_mm.toFixed(6)}\\ \\mathrm{mm} = ${toExp3(res.uDA_m)}\\ \\mathrm{m}$$</div>
            <div class="step-formula">B类不确定度：$u_B(D) = \\frac{0.02}{\\sqrt{3}} = ${res.uDB_mm.toFixed(6)}\\ \\mathrm{mm} = ${toExp3(res.uDB_m)}\\ \\mathrm{m}$</div>
            <div class="step-formula">合成不确定度：$u(D) = \\sqrt{u_A^2 + u_B^2} = \\sqrt{(${res.uDA_mm.toFixed(6)})^2 + (${res.uDB_mm.toFixed(6)})^2} = ${res.uD_mm.toFixed(6)}\\ \\mathrm{mm} = ${toExp3(res.uD_m)}\\ \\mathrm{m}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">3. 一元线性回归 ($x = R_x$, $y = l$)</div>
            <div class="step-formula">数据对 ($x_i$ / $\\Omega$, $y_i$ / m)：<br>
                ${res.Rx.map((x, idx) => `(${toExp3(x)}, ${toExp3(res.length_mm[idx]/1000)})`).join('<br>')}
            </div>
            <div class="step-formula">均值：$\\bar{x} = \\frac{1}{8}\\sum x_i = ${toExp3(res.reg.x_mean)}\\,\\Omega$， $\\bar{y} = \\frac{1}{8}\\sum y_i = ${toExp3(res.reg.y_mean)}\\,\\mathrm{m}$</div>
            <div class="step-formula">$\\sum xy = \\sum (x_i - \\bar{x})(y_i - \\bar{y}) = ${toExp3(res.reg.sumXY)}\\,\\Omega\\cdot\\mathrm{m}$</div>
            <div class="step-formula">$\\sum x^2 = \\sum (x_i - \\bar{x})^2 = ${toExp3(res.reg.sumXX)}\\,\\Omega^2$</div>
            <div class="step-formula">$\\sum y^2 = \\sum (y_i - \\bar{y})^2 = ${toExp3(res.reg.sumYY)}\\,\\mathrm{m}^2$</div>
            <div class="step-formula">斜率 $\\hat{b} = \\frac{\\sum xy}{\\sum x^2} = \\frac{${toExp3(res.reg.sumXY)}}{${toExp3(res.reg.sumXX)}} = ${toExp3(res.reg.slope)}\\,\\mathrm{m/\\Omega}$</div>
            <div class="step-formula">截距 $\\hat{a} = \\bar{y} - \\hat{b}\\bar{x} = ${toExp3(res.reg.intercept)}\\,\\mathrm{m}$</div>
            <div class="step-formula">相关系数 $r = \\frac{\\sum xy}{\\sqrt{\\sum x^2 \\sum y^2}} = \\frac{${toExp3(res.reg.sumXY)}}{\\sqrt{${toExp3(res.reg.sumXX)} \\times ${toExp3(res.reg.sumYY)}}} = ${res.reg.r.toFixed(6)}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">4. 斜率 $\\hat{b}$ 的不确定度</div>
            <div class="step-formula">A类不确定度：</div>
            <div class="step-formula">$$u_A(\\hat{b}) =  \\hat{b} \\sqrt{\\frac{1}{n-2}\\left(\\frac{1}{r^2} - 1\\right)} = ${toExp3(res.reg.slope)} \\times \\sqrt{\\frac{1}{6}\\left(\\frac{1}{${res.reg.r.toFixed(6)}^2} - 1\\right)} = ${toExp3(res.uBA)}\\,\\mathrm{m/\\Omega}$$</div>
            <div class="step-formula">B类不确定度：</div>
            <div class="step-formula">$u_B(R_x) = \\frac{0.05\\% \\times \\overline{R_x}}{\\sqrt{3}} = \\frac{0.0005 \\times ${toExp3(res.Rx_avg)}}{\\sqrt{3}} = ${toExp3(res.uRxB)}\\,\\Omega$</div>
            <div class="step-formula">$u_B(l) = \\frac{0.05\\,\\mathrm{mm}}{\\sqrt{3}} = \\frac{0.05\\times10^{-3}}{\\sqrt{3}} = ${toExp3(res.ulB_m)}\\,\\mathrm{m}$</div>
            <div class="step-formula">$u_B(D) = \\frac{0.02\\,\\mathrm{mm}}{\\sqrt{3}} = \\frac{0.02\\times10^{-3}}{\\sqrt{3}} = ${toExp3(res.uDB_m)}\\,\\mathrm{m}$</div>
            <div class="step-formula">相对量：</div>
            <div class="step-formula">$\\frac{2u_B(D)}{\\bar{D}} = \\frac{2 \\times ${toExp3(res.uDB_m)}}{${toExp3(res.D_avg_m)}} = ${(2*res.uDB_m/res.D_avg_m).toExponential(3)}$</div>
            <div class="step-formula">$\\frac{u_B(R_x)}{\\overline{R_x}} = \\frac{${toExp3(res.uRxB)}}{${toExp3(res.Rx_avg)}} = ${(res.uRxB/res.Rx_avg).toExponential(3)}$</div>
            <div class="step-formula">$\\frac{u_B(l)}{\\bar{l}} = \\frac{${toExp3(res.ulB_m)}}{${toExp3(res.l_avg_m)}} = ${(res.ulB_m/res.l_avg_m).toExponential(3)}$</div>
            <div class="step-formula">合成：$u_B(\\hat{b}) = \\hat{b} \\sqrt{\\left(\\frac{2u_B(D)}{\\bar{D}}\\right)^2 + \\left(\\frac{u_B(R_x)}{\\overline{R_x}}\\right)^2 + \\left(\\frac{u_B(l)}{\\bar{l}}\\right)^2}$</div>
            <div class="step-formula">$$= ${toExp3(res.reg.slope)} \\times \\sqrt{${(2*res.uDB_m/res.D_avg_m).toExponential(3)}^2 + ${(res.uRxB/res.Rx_avg).toExponential(3)}^2 + ${(res.ulB_m/res.l_avg_m).toExponential(3)}^2} = ${toExp3(res.uBB)}\\,\\mathrm{m/\\Omega}$$</div>
            <div class="step-formula">合成不确定度：$u(\\hat{b}) = \\sqrt{u_A^2 + u_B^2} = \\sqrt{(${toExp3(res.uBA)})^2 + (${toExp3(res.uBB)})^2} = ${toExp3(res.uB_m)}\\,\\mathrm{m/\\Omega}$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">5. 电阻率 $\\rho$ 计算</div>
            <div class="step-formula">$$\\rho = \\frac{\\pi \\bar{D}^2}{4\\hat{b}} = \\frac{\\pi \\times (${toExp3(res.D_avg_m)}\\,\\mathrm{m})^2}{4 \\times ${toExp3(res.reg.slope)}\\,\\mathrm{m/\\Omega}} = ${toExp3(res.rho)}\\,\\Omega\\cdot\\mathrm{m}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">6. 合成不确定度 $u(\\rho)$</div>
            <div class="step-formula">$2\\frac{u(D)}{\\bar{D}} = 2 \\times \\frac{${toExp3(res.uD_m)}}{${toExp3(res.D_avg_m)}} = ${(2*res.uD_m/res.D_avg_m).toExponential(3)}$</div>
            <div class="step-formula">$\\frac{u(\\hat{b})}{\\hat{b}} = \\frac{${toExp3(res.uB_m)}}{${toExp3(res.reg.slope)}} = ${(res.uB_m/res.reg.slope).toExponential(3)}$</div>
            <div class="step-formula">$$\\frac{u(\\rho)}{\\rho} = \\sqrt{ \\left(2\\frac{u(D)}{\\bar{D}}\\right)^2 + \\left(\\frac{u(\\hat{b})}{\\hat{b}}\\right)^2 } = \\sqrt{ (${(2*res.uD_m/res.D_avg_m).toExponential(3)})^2 + (${(res.uB_m/res.reg.slope).toExponential(3)})^2 } = ${res.relU.toExponential(3)}$$</div>
            <div class="step-formula">$$u(\\rho) = \\rho \\times \\frac{u(\\rho)}{\\rho} = ${toExp3(res.rho)} \\times ${res.relU.toExponential(3)} = ${toExp3(res.uRho)}\\,\\Omega\\cdot\\mathrm{m}$$</div>
        </div>

        <div class="calculation-step">
            <div class="step-title">7. 最终结果</div>
            <div class="step-result" style="font-size:1.2rem;">$\\rho = (${rhoSci} \\pm ${uSci})\\,\\Omega\\cdot\\mathrm{m}$</div>
            <div class="step-result">相对不确定度 = $\\frac{u(\\rho)}{\\rho} = ${(res.relU*100).toFixed(2)}\\%$</div>
        </div>
        `;

        document.getElementById('calculationProcess').innerHTML = html;
        window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
    }

    // ---------- 显示主要结果 ----------
// ---------- 修改后的 displayResults ----------
function displayResults(res) {
    // 使用 formatResultWithUncertainty 获得修约后的字符串
    const fmt = window.ExperimentUtils.formatResultWithUncertainty(res.rho, res.uRho, true);
    const rhoSci = toSciAfterRounding(fmt.value);
    const uSci = toSciAfterRounding(fmt.uncertainty);
    
    document.getElementById('rho_val').innerText = rhoSci + ' Ω·m';
    document.getElementById('urho_val').innerText = uSci + ' Ω·m';
    document.getElementById('rel_urho_val').innerText = (res.relU * 100).toFixed(2) + '%';
    
    renderProcess(res); // 此函数内部最后一步也需同步修改，见下方说明
    document.getElementById('resultMain').style.display = 'block';
    document.getElementById('processSection').style.display = 'block';
}

    // ---------- 计算入口 ----------
    function calculate() {
        const data = getInputs();
        if (!isValid(data)) {
            alert('数据不完整或格式错误，请确保所有测量值已填满且 R_N > 0');
            return;
        }
        try {
            const results = compute(data);
            displayResults(results);
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        } catch (e) {
            console.error(e);
            alert('计算过程出错，请检查数据');
        }
    }

    function saveOnly() {
        window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
        alert('数据已保存');
    }

    // ---------- 页面初始化 ----------
    window.addEventListener('DOMContentLoaded', function() {
        const TableGenerator = window.ExperimentUtils.TableGenerator;

        // 生成电桥测量表格 (8行4列)
        TableGenerator.generateInputTable('bridge-table-container', {
            rows: 8,
            cols: 4,
            colHeaders: ['次数','接入长度 l (mm)', 'R₁和R₂ (Ω)', '正向电阻 $R_正$ (Ω)', '反向电阻 $R_负$ (Ω)'],
            rowHeaders: ['1','2','3','4','5','6','7','8'],
            prefix: 'bridge_',
            // 示例默认值
            defaultValues: [
                100.0, 0.1000, 0.00125, 0.00123,
                200.0, 0.1000, 0.00251, 0.00249,
                300.0, 0.1000, 0.00378, 0.00376,
                400.0, 0.1000, 0.00502, 0.00500,
                500.0, 0.1000, 0.00630, 0.00628,
                600.0, 0.1000, 0.00755, 0.00753,
                700.0, 0.1000, 0.00880, 0.00878,
                800.0, 0.1000, 0.01005, 0.01003
            ]
        });

        // 生成直径测量表格 (8行1列)
        TableGenerator.generateInputTable('diameter-table-container', {
            rows: 8,
            cols: 1,
            colHeaders: ['次数','直径 $D_i$ (mm)'],
            rowHeaders: ['1','2','3','4','5','6','7','8'],
            prefix: 'diam_',
            defaultValues: [5.00, 5.01, 4.99, 5.00, 5.02, 4.98, 5.00, 5.00]
        });

        // 加载保存数据（会覆盖默认值）
        window.ExperimentUtils.Storage.loadToInputs(APP_KEY);

        // 键盘导航
        window.ExperimentUtils.KeyboardNav.init('#bridge-table-container', 4);
        window.ExperimentUtils.KeyboardNav.init('#diameter-table-container', 1);

        // 深色模式
        window.ExperimentUtils.ThemeManager.init();

        // 绑定按钮
        document.getElementById('calculateBtn').addEventListener('click', calculate);
        document.getElementById('saveBtn').addEventListener('click', saveOnly);
    });
})();
</script>
</body>
</html>