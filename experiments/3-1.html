<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基物实验助手 - 振幅法测声速</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="style.css">
    <!-- 引入公共工具库 -->
    <script src="common.js"></script>
    <!-- MathJax 配置 -->
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            svg: { fontCache: 'global' }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-svg.js" id="MathJax-script" async></script>
</head>
<body>
<div class="container">
    <div class="page-title">振幅法测声速</div>

    <div class="tip-box">
        <strong>Tips</strong><br>
        • 开始频率 f₁ (kHz) · 结束频率 f₂ (kHz) · 室温 t (℃)<br>
        • L₁~L₁₀ 为探头位置 (mm)。<br>
    </div>

    <!-- 原始数据输入区 -->
    <div class="section">
        <div class="section-title">原始数据录入</div>
        <div class="top-input-group">
            <div class="top-input"><label>f₁ (kHz)</label><input type="number" id="f1" class="save-input cell-input" step="0.001" value="34.5"></div>
            <div class="top-input"><label>f₂ (kHz)</label><input type="number" id="f2" class="save-input cell-input" step="0.001" value="34.6"></div>
            <div class="top-input"><label>t (℃)</label><input type="number" id="t" class="save-input cell-input" step="0.1" value="20.5"></div>
        </div>

        <!-- 动态生成的 L 表格将放在这里 -->
        <div id="L-table-container"></div>
    </div>

    <!-- 操作按钮组 -->
    <div class="action-buttons">
        <button class="primary" id="calculateBtn">计算并保存</button>
        <button id="saveBtn">仅保存数据</button>
    </div>

    <!-- 主要结果显示区 -->
    <div class="section" id="resultMain" style="display: none;">
        <div class="section-title">测量结果</div>
        <div class="result-grid">
            <div class="result-card"><div class="result-label">声速 v (m/s)</div><div class="result-value" id="v_val">—</div></div>
            <div class="result-card"><div class="result-label">不确定度 u(v) (m/s)</div><div class="result-value" id="uv_val">—</div></div>
            <div class="result-card"><div class="result-label">理论值 v<sub>theo</sub> (m/s)</div><div class="result-value" id="v_theo_val">—</div></div>
            <div class="result-card"><div class="result-label">相对误差 (%)</div><div class="result-value" id="relerr_val">—</div></div>
        </div>
    </div>

    <!-- 详细计算过程 -->
    <div class="section" id="processSection" style="display: none;">
        <div class="section-title">详细计算过程</div>
        <div class="process-container" id="calculationProcess"></div>
    </div>

    <!-- 免责声明 -->
    <div class="disclaimer" style="text-align: center;">
        开源项目禁止商用 ｜ 自行核对计算数据
    </div>
</div>

<script>
    (function() {
        // ---------- 实验专用常量 ----------
        const APP_KEY = '3-1';
        const X_VALS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];  // 测量次数

        // 初始化动态表格 (1行10列，列标题 L₁~L₁₀)
        window.ExperimentUtils.TableGenerator.generateInputTable('L-table-container', {
            rows: 1,
            cols: 10,
            colHeaders: ['L₁(mm)', 'L₂(mm)', 'L₃(mm)', 'L₄(mm)', 'L₅(mm)', 'L₆(mm)', 'L₇(mm)', 'L₈(mm)', 'L₉(mm)', 'L₁₀(mm)'],
            prefix: 'L',
            defaultValues: [9.58, 14.84, 20.10, 25.36, 30.62, 35.88, 41.14, 46.40, 51.66, 56.92]
        });

        // 获取当前输入值
        function getInputs() {
            return {
                f1: parseFloat(document.getElementById('f1').value) || 0,
                f2: parseFloat(document.getElementById('f2').value) || 0,
                t: parseFloat(document.getElementById('t').value) || 0,
                L: X_VALS.map((_, i) => parseFloat(document.getElementById(`L${i+1}`).value) || NaN)
            };
        }

        function isValid(data) {
            if (data.f1 <= 0 || data.f2 <= 0 || data.t == 0) return false;
            if (data.L.some(isNaN)) return false;
            return true;
        }

        function compute(data) {
            const { f1, f2, t, L } = data;
            const utils = window.ExperimentUtils.Data;
            const reg = utils.linearRegression(X_VALS, L);
            const b = reg.slope;
            const r = reg.r;

            const lambda = 2 * b;
            const f = (f1 + f2) / 2;
            const v = lambda * f;
            const vTheo = 331.45 * Math.sqrt(1 + t / 273.15);

            const u_f = Math.abs(f1 - f2) / Math.sqrt(3);
            const ua_b = (Math.abs(r) < 1e-10) ? 0 : b * Math.sqrt((1/8) * (1/(r*r) - 1));
            const ub1 = 0.005 / Math.sqrt(3);
            const ub2 = 0.01 / Math.sqrt(3);
            const ub_b = Math.sqrt(ub1*ub1 + ub2*ub2);
            const u_b = Math.sqrt(ua_b*ua_b + ub_b*ub_b);
            const u_lambda = 2 * u_b;
            const rel_u = Math.sqrt( (u_f/f)**2 + (u_lambda/lambda)**2 );
            const u_v = v * rel_u;
            const relErr = Math.abs(v - vTheo) / vTheo * 100;

            return {
                reg, b, lambda, f, v, vTheo,
                ua_b, ub_b, u_b, u_lambda, u_f, u_v,
                ub1, ub2, relErr
            };
        }

        function renderProcess(data, res) {
            const { f1, f2, t } = data;
            const { reg, b, lambda, f, v, vTheo, ua_b, ub_b, u_b, u_lambda, u_f, u_v, ub1, ub2, relErr } = res;

            const fmt = (x, d=4) => x.toFixed(d);
            const fmt6 = (x) => x.toFixed(6);

            const html = `
            <div class="calculation-step">
                <div class="step-title">1. 一元线性回归中间量</div>
                <div class="step-formula">$$\\bar{x} = \\frac{1}{10}\\sum x_i = ${fmt(reg.x_mean,3)}$$</div>
                <div class="step-formula">$$\\bar{y} = \\frac{1}{10}\\sum L_i = ${fmt(reg.y_mean,3)}$$</div>
                <div class="step-formula">$$\\sum xy = ${fmt(reg.sumXY,3)}$$</div>
                <div class="step-formula">$$\\sum x^2 = ${fmt(reg.sumXX,3)}$$</div>
                <div class="step-formula">$$\\sum y^2 = ${fmt(reg.sumYY,3)}$$</div>
                <div class="step-result">斜率 $b = \\frac{n\\sum xy - \\sum x\\sum y}{n\\sum x^2-(\\sum x)^2} = ${fmt(b,6)}$ mm/次</div>
                <div class="step-result">截距 $a = ${fmt(reg.intercept,4)}$ mm</div>
                <div class="step-result">相关系数 $r = ${fmt(reg.r,6)}$</div>
            </div>
            <div class="calculation-step">
                <div class="step-title">2. 波长 λ 与频率 f</div>
                <div class="step-formula">$$\\lambda = 2b = 2 \\times ${fmt(b,6)} = ${fmt(lambda,6)}\\ \\text{mm}$$</div>
                <div class="step-formula">$$f = \\frac{f_1+f_2}{2} = \\frac{${f1}+${f2}}{2} = ${fmt(f,6)}\\ \\text{kHz}$$</div>
                <div class="step-result">声速 $v = \\lambda \\cdot f = ${fmt(lambda,6)} \\times ${fmt(f,6)} = ${fmt(v,4)}$ m/s</div>
            </div>
            <div class="calculation-step">
                <div class="step-title">3. 理论值</div>
                <div class="step-formula">$$v_{\\text{theo}} = 331.45\\sqrt{1+\\frac{t}{273.15}} = 331.45\\sqrt{1+\\frac{${t}}{273.15}}$$</div>
                <div class="step-result">$v_{\\text{theo}} = ${fmt(vTheo,4)}$ m/s</div>
            </div>
            <div class="calculation-step">
                <div class="step-title">4. 不确定度分量</div>
                <div class="step-formula">$u(f) = \\frac{|f_1-f_2|}{\\sqrt{3}} = \\frac{|${f1}-${f2}|}{\\sqrt{3}} = ${fmt(u_f,6)}$ kHz</div>
                <div class="step-formula">$u_A(b) = b\\sqrt{\\frac{1}{8}\\left(\\frac{1}{r^2}-1\\right)} = ${fmt(b,6)}\\sqrt{\\frac{1}{8}\\left(\\frac{1}{${fmt(reg.r,6)}^2}-1\\right)} = ${fmt(ua_b,6)}$ mm</div>
                <div class="step-formula">$u_{B1}(b) = \\frac{0.005}{\\sqrt{3}} = ${fmt(ub1,6)}$ mm,  $u_{B2}(b) = \\frac{0.01}{\\sqrt{3}} = ${fmt(ub2,6)}$ mm</div>
                <div class="step-formula">$u_B(b) = \\sqrt{u_{B1}^2+u_{B2}^2} = ${fmt(ub_b,6)}$ mm</div>
                <div class="step-formula">$u(b) = \\sqrt{u_A(b)^2+u_B(b)^2} = \\sqrt{(${fmt(ua_b,6)})^2+(${fmt(ub_b,6)})^2} = ${fmt(u_b,6)}$ mm</div>
                <div class="step-formula">$u(\\lambda) = 2u(b) = ${fmt(u_lambda,6)}$ mm</div>
                <div class="step-formula">$u(v) = v\\sqrt{\\left(\\frac{u(f)}{f}\\right)^2+\\left(\\frac{u(\\lambda)}{\\lambda}\\right)^2} = ${fmt(v,4)}\\sqrt{\\left(\\frac{${fmt(u_f,6)}}{${fmt(f,6)}}\\right)^2+\\left(\\frac{${fmt(u_lambda,6)}}{${fmt(lambda,6)}}\\right)^2} = ${fmt(u_v,4)}$ m/s</div>
            </div>
            <div class="calculation-step">
                <div class="step-title">5. 最终结果</div>
                <div class="step-result" style="font-size:1.2rem;">$v = (${fmt(v,1)} \\pm ${fmt(u_v,1)})\\ \\text{m/s}$</div>
                <div class="step-result">相对误差 = $\\frac{|v-v_{\\text{theo}}|}{v_{\\text{theo}}} \\times 100\\% = ${fmt(relErr,2)}$ %</div>
            </div>
            `;

            document.getElementById('calculationProcess').innerHTML = html;
            window.ExperimentUtils.renderMath(document.getElementById('calculationProcess'));
        }

        function displayResults(res) {
            document.getElementById('v_val').innerText = res.v.toFixed(3);
            document.getElementById('uv_val').innerText = res.u_v.toFixed(3);
            document.getElementById('v_theo_val').innerText = res.vTheo.toFixed(3);
            document.getElementById('relerr_val').innerText = res.relErr.toFixed(2);
            document.getElementById('resultMain').style.display = 'block';
            document.getElementById('processSection').style.display = 'block';
        }

        function calculate() {
            const data = getInputs();
            if (!isValid(data)) {
                alert('请完整填写所有数据');
                return;
            }
            try {
                const results = compute(data);
                displayResults(results);
                renderProcess(data, results);
                window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
            } catch (e) {
                console.error(e);
                alert('计算过程出错，请检查数据格式或联系开发者');
            }
        }

        function saveOnly() {
            window.ExperimentUtils.Storage.saveFromInputs(APP_KEY);
            alert('数据已保存');
        }

        // 初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 加载已保存数据
            window.ExperimentUtils.Storage.loadToInputs(APP_KEY);
            // 启用键盘导航（表格内共10列）
            window.ExperimentUtils.KeyboardNav.init('#L-table-container .data-table', 10);
            // 初始化深色模式
            window.ExperimentUtils.ThemeManager.init();
            // 绑定按钮
            document.getElementById('calculateBtn').addEventListener('click', calculate);
            document.getElementById('saveBtn').addEventListener('click', saveOnly);
        });
    })();
</script>
</body>
</html>